<!DOCTYPE html>
<!-- saved from url=(0036)https://www.lowlevel.eu/wiki/RTL8139 -->
<html class="client-js translated-ltr" lang="en" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>RTL8139 - low level</title>
<script>document.documentElement.className = document.documentElement.className.replace( /(^|\s)client-nojs(\s|$)/, "$1client-js$2" );</script>
<script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"RTL8139","wgTitle":"RTL8139","wgCurRevisionId":11297,"wgRevisionId":11297,"wgArticleId":1533,"wgIsArticle":true,"wgIsRedirect":false,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["Tutorials","Netzwerkkarte"],"wgBreakFrames":false,"wgPageContentLanguage":"de","wgPageContentModel":"wikitext","wgSeparatorTransformTable":[",\t.",".\t,"],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"],"wgMonthNamesShort":["","Jan.","Feb.","Mär.","Apr.","Mai","Jun.","Jul.","Aug.","Sep.","Okt.","Nov.","Dez."],"wgRelevantPageName":"RTL8139","wgRelevantArticleId":1533,"wgRequestId":"4ef1e836f97be0e38906a452","wgIsProbablyEditable":false,"wgRelevantPageIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[]});mw.loader.state({"site.styles":"ready","noscript":"ready","user.styles":"ready","user":"ready","site":"ready","user.options":"loading","user.tokens":"loading","mediawiki.legacy.shared":"ready","mediawiki.legacy.commonPrint":"ready","mediawiki.sectionAnchor":"ready","mediawiki.skinning.interface":"ready","mediawiki.skinning.content.externallinks":"ready","skins.monobook.styles":"ready"});mw.loader.implement("user.options@1wzrrbt",function($,jQuery,require,module){/*@nomin*/mw.user.options.set({"variant":"de"});
});mw.loader.implement("user.tokens@0sm3ue4",function($,jQuery,require,module){/*@nomin*/mw.user.tokens.set({"editToken":"+\\","patrolToken":"+\\","watchToken":"+\\","csrfToken":"+\\"});
});mw.loader.load(["mediawiki.page.startup","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.toc","mediawiki.searchSuggest"]);});</script>
<link rel="stylesheet" href="./RTL8139__LowLevel_EnUs_files/load.php">
<script async="" src="./RTL8139__LowLevel_EnUs_files/load(1).php"></script>
<!--[if IE 6]><link rel="stylesheet" href="/w/skins/MonoBook/resources/IE60Fixes.css?303" media="screen"/><![endif]--><!--[if IE 7]><link rel="stylesheet" href="/w/skins/MonoBook/resources/IE70Fixes.css?303" media="screen"/><![endif]-->
<style>
.suggestions{overflow:hidden;position:absolute;top:0;left:0;width:0;border:0;z-index:1099;padding:0;margin:-1px 0 0 0}.suggestions-special{position:relative;background-color:#fff;cursor:pointer;border:1px solid #a2a9b1;margin:0;margin-top:-2px;display:none;padding:0.25em 0.25em;line-height:1.25em}.suggestions-results{background-color:#fff;cursor:pointer;border:1px solid #a2a9b1;padding:0;margin:0}.suggestions-result{color:#000;margin:0;line-height:1.5em;padding:0.01em 0.25em;text-align:left; overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.suggestions-result-current{background-color:#2a4b8d;color:#fff}.suggestions-special .special-label{color:#72777d;text-align:left}.suggestions-special .special-query{color:#000;font-style:italic;text-align:left}.suggestions-special .special-hover{background-color:#c8ccd1}.suggestions-result-current .special-label,.suggestions-result-current .special-query{color:#fff}.highlight{font-weight:bold}
@media screen {
	.tochidden,.toctoggle{-moz-user-select:none;-webkit-user-select:none;-ms-user-select:none;user-select:none}.toctoggle{font-size:94%}}
@media print {
	.toc.tochidden,.toctoggle{display:none}}</style><style>
.suggestions a.mw-searchSuggest-link,.suggestions a.mw-searchSuggest-link:hover,.suggestions a.mw-searchSuggest-link:active,.suggestions a.mw-searchSuggest-link:focus{color:#000;text-decoration:none}.suggestions-result-current a.mw-searchSuggest-link,.suggestions-result-current a.mw-searchSuggest-link:hover,.suggestions-result-current a.mw-searchSuggest-link:active,.suggestions-result-current a.mw-searchSuggest-link:focus{color:#fff}.suggestions a.mw-searchSuggest-link .special-query{ overflow:hidden;text-overflow:ellipsis;white-space:nowrap}</style><meta name="ResourceLoaderDynamicStyles" content="">
<link rel="stylesheet" href="./RTL8139__LowLevel_EnUs_files/load(2).php">
<meta name="generator" content="MediaWiki 1.31.7">
<link rel="shortcut icon" href="https://www.lowlevel.eu/Favicon.png">
<link rel="search" type="application/opensearchdescription+xml" href="https://www.lowlevel.eu/w/opensearch_desc.php" title="Lowlevel (de)">
<link rel="EditURI" type="application/rsd+xml" href="https://www.lowlevel.eu/w/api.php?action=rsd">
<link rel="license" href="https://creativecommons.org/licenses/by-nc-sa/3.0/de/">
<link rel="alternate" type="application/atom+xml" title="Atom feed for &quot;low level&quot;" href="https://www.lowlevel.eu/w/index.php?title=Spezial:Letzte_%C3%84nderungen&amp;feed=atom">
<!--[if lt IE 9]><script src="/w/load.php?debug=false&amp;lang=de&amp;modules=html5shiv&amp;only=scripts&amp;skin=monobook&amp;sync=1"></script><![endif]-->
<script src="./RTL8139__LowLevel_EnUs_files/load(3).php"></script><link type="text/css" rel="stylesheet" charset="UTF-8" href="./RTL8139__LowLevel_EnUs_files/translateelement.css"></head>
<body class="mediawiki ltr sitedir-ltr capitalize-all-nouns mw-hide-empty-elt ns-0 ns-subject page-RTL8139 rootpage-RTL8139 skin-monobook action-view"><div id="globalWrapper"><div id="column-content"><div id="content" class="mw-body" role="main"><a id="top"></a><div class="mw-indicators mw-body-content">
</div>
<h1 id="firstHeading" class="firstHeading" lang="de"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTL8139</font></font></h1><div id="bodyContent" class="mw-body-content"><div id="siteSub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">From low level</font></font></div><div id="contentSub" lang="de" dir="ltr"></div><div id="jump-to-nav" class="mw-jump"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jump to: </font></font><a href="https://www.lowlevel.eu/wiki/RTL8139#column-one"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">navigation</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://www.lowlevel.eu/wiki/RTL8139#searchInput"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">search</font></font></a></div><!-- start content --><div id="mw-content-text" lang="de" dir="ltr" class="mw-content-ltr"><div class="mw-parser-output"><div id="toc" class="toc"><div class="toctitle" lang="de" dir="ltr"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Table of Contents</font></font></h2><span class="toctoggle"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&nbsp;[ </font></font><a role="button" tabindex="0" class="togglelink"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hide</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ]&nbsp;</font></font></span></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="https://www.lowlevel.eu/wiki/RTL8139#Grunds.C3.A4tzliches"><span class="tocnumber"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span> <span class="toctext"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Basics</font></font></span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="https://www.lowlevel.eu/wiki/RTL8139#Voraussetzungen"><span class="tocnumber"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.1 </font></font></span> <span class="toctext"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Requirements</font></font></span></a></li>
<li class="toclevel-2 tocsection-3"><a href="https://www.lowlevel.eu/wiki/RTL8139#Funktionweise"><span class="tocnumber"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1.2 </font></font></span> <span class="toctext"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How it works</font></font></span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-4"><a href="https://www.lowlevel.eu/wiki/RTL8139#Initialisierung"><span class="tocnumber"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 </font></font></span> <span class="toctext"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initialization</font></font></span></a></li>
<li class="toclevel-1 tocsection-5"><a href="https://www.lowlevel.eu/wiki/RTL8139#Senden_eines_Pakets"><span class="tocnumber"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 </font></font></span> <span class="toctext"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Send a packet</font></font></span></a></li>
<li class="toclevel-1 tocsection-6"><a href="https://www.lowlevel.eu/wiki/RTL8139#Empfangen"><span class="tocnumber"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 </font></font></span> <span class="toctext"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Receive</font></font></span></a></li>
<li class="toclevel-1 tocsection-7"><a href="https://www.lowlevel.eu/wiki/RTL8139#Sonstiges"><span class="tocnumber"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5 </font></font></span> <span class="toctext"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">other</font></font></span></a>
<ul>
<li class="toclevel-2 tocsection-8"><a href="https://www.lowlevel.eu/wiki/RTL8139#MAC-Adresse"><span class="tocnumber"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.1 </font></font></span> <span class="toctext"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MAC address</font></font></span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-9"><a href="https://www.lowlevel.eu/wiki/RTL8139#Siehe_auch"><span class="tocnumber"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6 </font></font></span> <span class="toctext"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">See also</font></font></span></a></li>
<li class="toclevel-1 tocsection-10"><a href="https://www.lowlevel.eu/wiki/RTL8139#Weblinks"><span class="tocnumber"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7 </font></font></span> <span class="toctext"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">web links</font></font></span></a></li>
</ul>
</div>

<h2><span id="Grundsätzliches"></span><span class="mw-headline" id="Grunds.C3.A4tzliches"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Basics</font></font></span></h2>
<h3><span class="mw-headline" id="Voraussetzungen"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">requirements</font></font></span></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I am assuming that anyone who intends to use this tutorial to write a network driver for the RTL8139 chip is already at a certain level with their system. </font><font style="vertical-align: inherit;">Basics such as receiving IRQs or memory management are a matter of course, and there should also be a way to find out IRQs and ports of PCI devices.
</font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I recommend qemu as an emulator. </font><font style="vertical-align: inherit;">You must specify -net parameters on the command line, for example:
</font></font></p>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qemu -fda lost.img -net nic, model = rtl8139 -net user</font></font></pre>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With these parameters, qemu emulates a network card with an RTL8139 chipset, which is located in a virtual network. </font><font style="vertical-align: inherit;">You can access the large, wide internet via the virtual qemu router at the IP address 10.0.2.2.
</font></font></p>
<h3><span class="mw-headline" id="Funktionweise"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How it works</font></font></span></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As already mentioned, the chipset uses different resources:
</font></font></p>
<ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ports: The registers of the network card, via which the basic configuration is carried out, can be addressed via I / O ports.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IRQ: Among other things, an IRQ is triggered as soon as an Ethernet packet has arrived or a packet has been sent.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memory: A ring buffer in the main memory is used for sending and receiving. </font><font style="vertical-align: inherit;">Ring buffer means that the buffer is filled normally from start to finish. </font><font style="vertical-align: inherit;">Subsequently, the process starts again at the beginning of the buffer and continues filling there (if the old data has been processed there, otherwise an error occurs).</font></font></li></ul>
<h2><span class="mw-headline" id="Initialisierung"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">initialization</font></font></span></h2>
<ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Get the IRQ and I / O ports from the PCI driver</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Register the IRQ handler and, if necessary, I / O ports</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carry out a card reset: set bit 4 in the command register (0x37, 1 byte). </font><font style="vertical-align: inherit;">When I enter port numbers of registers here, it means the offset to the first port of the card, which has to be determined by the PCI functions.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Activating the transmitter and the receiver: Set bits 2 and 3 (TE or RE) in the command register (0x37, 1 byte). </font><font style="vertical-align: inherit;">This is said not to happen until later, otherwise the following commands would be ignored.</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set TCR (Transmit Configuration Register, 0x40, 4 bytes) and RCR (Receive Configuration Register, 0x44, 4 bytes). </font><font style="vertical-align: inherit;">At this point, no further comment: TCR = 0x03000700, RCR = 0x0000070a</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Initialize buffers for reception (possibly also for sending, but this can also happen later). </font><font style="vertical-align: inherit;">With the suggested values ​​we need 8K + 16 bytes for the receive buffer and a sufficiently large send buffer. </font><font style="vertical-align: inherit;">What means sufficient depends on how much we want to send at once. </font><font style="vertical-align: inherit;">Then the physical (!) Address of the receive buffer must be written to RBSTART (0x30, 4 bytes).</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Set interrupt mask (0x3C, 2 bytes). </font><font style="vertical-align: inherit;">The events that should trigger an IRQ can be selected in this register. </font><font style="vertical-align: inherit;">For the sake of simplicity, we take all and set 0xffff.</font></font></li></ol>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Constants from the tındur code: &lt;c&gt; // port numbers of the registers
</font></font></p>
<ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define REG_ID0 0x00</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define REG_ID4 0x04</font></font></li></ol>
<ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define REG_TRANSMIT_STATUS0 0x10</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define REG_TRANSMIT_ADDR0 0x20</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define REG_RECEIVE_BUFFER 0x30</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define REG_COMMAND 0x37</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define REG_CUR_READ_ADDR 0x38</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define REG_INTERRUPT_MASK 0x3C</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define REG_INTERRUPT_STATUS 0x3E</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define REG_TRANSMIT_CONFIGURATION 0x40</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define REG_RECEIVE_CONFIGURATION 0x44</font></font></li></ol>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// values ​​for the registers // control registers
</font></font></p>
<ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define CR_RESET (1 &lt;&lt; 4)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define CR_RECEIVER_ENABLE (1 &lt;&lt; 3)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define CR_TRANSMITTER_ENABLE (1 &lt;&lt; 2)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define CR_BUFFER_IS_EMPTY (1 &lt;&lt; 0)</font></font></li></ol>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// transmitter configuration
</font></font></p>
<ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define TCR_IFG_STANDARD (3 &lt;&lt; 24)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define TCR_MXDMA_512 (5 &lt;&lt; 8)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define TCR_MXDMA_1024 (6 &lt;&lt; 8)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define TCR_MXDMA_2048 (7 &lt;&lt; 8)</font></font></li></ol>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// Receiver configuration
</font></font></p>
<ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define RCR_MXDMA_512 (5 &lt;&lt; 8)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define RCR_MXDMA_1024 (6 &lt;&lt; 8)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define RCR_MXDMA_UNLIMITED (7 &lt;&lt; 8)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define RCR_ACCEPT_BROADCAST (1 &lt;&lt; 3)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define RCR_ACCEPT_MULTICAST (1 &lt;&lt; 2)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define RCR_ACCEPT_PHYS_MATCH (1 &lt;&lt; 1)</font></font></li></ol>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// Interrupt status register
</font></font></p>
<ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define ISR_RECEIVE_BUFFER_OVERFLOW (1 &lt;&lt; 4)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define ISR_TRANSMIT_OK (1 &lt;&lt; 2)</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">define ISR_RECEIVE_OK (1 &lt;&lt; 0)</font></font></li></ol>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;/c&gt;
</font></font></p>
<h2><span class="mw-headline" id="Senden_eines_Pakets"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Send a package</font></font></span></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sending is actually a very simple exercise after everything is configured. </font><font style="vertical-align: inherit;">At the latest here we need a send buffer from which we know the physical address. </font><font style="vertical-align: inherit;">Then we simply have to give this address to the network card.
</font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is another special feature to mention: ring buffers everywhere. </font><font style="vertical-align: inherit;">The card knows four descriptors for sending, which must always be used in order, otherwise nothing happens. </font><font style="vertical-align: inherit;">You can take advantage of this by preparing the next buffer as long as the first one has not been sent completely, but for the beginning it is enough to do it one by one.
</font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First the address must be written to TSDx (four registers from 0x10, 4 bytes each), then the size of the data to be transferred must be entered in TSAD (four registers from 0x20, 4 bytes each) (bits 0-12). </font><font style="vertical-align: inherit;">At the same time, bit 13 (OWN) is cleared, which triggers the transmission.
</font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The following is a code example as used in tındur: &lt;c&gt;
</font></font></p>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">   // Set the address and size of the buffer </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   // In TASD (REG_TRANSMIT_STATUS) the OWN bit is deleted, which </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   triggers </font><font style="vertical-align: inherit;">the </font><font style="vertical-align: inherit;">// actual transmission. </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   write_register_dword (netcard, </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
       REG_TRANSMIT_ADDR0 + (4 * netcard-&gt; cur_buffer), </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
       (dword) netcard-&gt; buffer.phys);</font></font>
</pre>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">   write_register_dword (netcard, </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
       REG_TRANSMIT_STATUS0 + (4 * netcard-&gt; cur_buffer), </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
       size);</font></font>
</pre>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">   // The four descriptors must be used in order </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   // even if we are currently using only one buffer </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   // and always waiting. </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   netcard-&gt; cur_buffer ++; </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   netcard-&gt; cur_buffer% = 4;</font></font>
</pre>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;/c&gt;
</font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As soon as the card is ready, it sends an IRQ and bit 2 (TOK = Transmit OK) is set in ISR (0x3E, 2 bytes). </font><font style="vertical-align: inherit;">After the necessary actions have been carried out (eg release the buffer again), the bit must be deleted. </font><font style="vertical-align: inherit;">Bits in ISR are deleted by setting them when writing. </font><font style="vertical-align: inherit;">To delete TOK, one would write 0x04 after ISR.
</font></font></p>
<h2><span class="mw-headline" id="Empfangen"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Receive</font></font></span></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As soon as a packet arrives, an IRQ is also triggered and bit 0 (ROK = Receive OK) is set in ISR (0x3E, 2 bytes). </font><font style="vertical-align: inherit;">Here, too, the bit should be deleted after the interrupt has been handled by writing 0x01 to ISR.
</font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When handling the interrupt, it should be noted that several packets may have arrived. </font><font style="vertical-align: inherit;">Therefore, packets must be read in a loop until bit 0 (BUFE = Buffer Empty) in the command register (CR, 0x37, 1 byte) is set. 
</font></font></p>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bytes 0-1: packet header (bit 0 = ROK) </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bytes 2-3: length of the packet </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bytes 4-n: data (payload) </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Bytes n + 1-n + 4: CRC checksum</font></font>
</pre>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What we absolutely need to know is our current position in the ring buffer (0 at the beginning). </font><font style="vertical-align: inherit;">At this point we can fetch two bytes of packet headers (bit 0 = ROK should be set there) and then fetch two bytes in length. </font><font style="vertical-align: inherit;">A corresponding number of bytes then follow, which contain the actual packet and, at the end, four bytes of CRC checksum (the latter can simply be ignored). 
</font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When reading the data, it is important to note that it is a ring buffer. </font><font style="vertical-align: inherit;">This means that the break could be somewhere in the middle of the data, where it starts again from zero. </font><font style="vertical-align: inherit;">By initially ignoring this fact, I crashed my driver in LOST.
</font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then the network card must be informed that we have read something. </font><font style="vertical-align: inherit;">To do this, we write the offset of the next expected packet in the CAPR (Current Address of Packet Read, 0x38, 2 Bytes) register:
</font></font></p><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;c&gt;
</font></font></p>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">   // Adjust the current offset in the read buffer. </font><font style="vertical-align: inherit;">Each package is </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   // dword-aligned, so rounding up afterwards. </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   netcard-&gt; rx_buffer_offset + = length + 4; </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   netcard-&gt; rx_buffer_offset = (netcard-&gt; rx_buffer_offset + 3) &amp; ~ 0x3;</font></font>
</pre>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">   // catch </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
   overflows netcard-&gt; rx_buffer_offset% = 0x2000;</font></font>
</pre>
<pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">   write_register_word (netcard, REG_CUR_READ_ADDR, </font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
       netcard-&gt; rx_buffer_offset - 0x10);</font></font>
</pre>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;/c&gt;
</font></font></p>
<h2><span class="mw-headline" id="Sonstiges"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">miscellaneous</font></font></span></h2>
<h3><span class="mw-headline" id="MAC-Adresse"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MAC address</font></font></span></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The MAC address is stored in the registers IDR0 to IDR5 (0x00 to 0x05) and can both be read and set there.
</font></font></p>
<h2><span class="mw-headline" id="Siehe_auch"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">See also</font></font></span></h2>
<ul><li><a href="https://www.lowlevel.eu/wiki/Ethernet" title="Ethernet"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ethernet</font></font></a></li></ul>
<h2><span class="mw-headline" id="Weblinks"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web links</font></font></span></h2>
<ul><li><a rel="nofollow" class="external text" href="http://www.cs.usfca.edu/~cruse/cs326/RTL8139D_DataSheet.pdf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTL8139 data sheet</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Chapter 5: Description of all registers)</font></font></li>
<li><a rel="nofollow" class="external text" href="http://www.cs.usfca.edu/~cruse/cs326/RTL8139_ProgrammersGuide.pdf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTL8139 (A / B) Programming Guide (V0.1)</font></font></a></li></ul>

<!-- 
NewPP limit report
Cached time: 20200512121826
Cache expiry: 86400
Dynamic content: false
CPU time usage: 0.008 seconds
Real time usage: 0.007 seconds
Preprocessor visited node count: 56/1000000
Preprocessor generated node count: 84/1000000
Post‐expand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
Highest expansion depth: 2/40
Expensive parser function count: 0/100
Unstrip recursion depth: 0/20
Unstrip post‐expand size: 209/5000000 bytes
-->
<!--
Transclusion expansion time report (%,ms,calls,template)
100.00%    0.000      1 -total
-->
</div>
<!-- Saved in parser cache with key lowlevel_wiki:pcache:idhash:1533-0!canonical and timestamp 20200512121826 and revision id 11297
 -->
</div><div class="printfooter">
Abgerufen von „<a dir="ltr" href="http://www.lowlevel.eu/w/index.php?title=RTL8139&amp;oldid=11297">http://www.lowlevel.eu/w/index.php?title=RTL8139&amp;oldid=11297</a>“</div>
<div id="catlinks" class="catlinks" data-mw="interface"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="https://www.lowlevel.eu/wiki/Spezial:Kategorien" title="Special: categories"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Categories</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><ul><li><a href="https://www.lowlevel.eu/wiki/Kategorie:Tutorials" title="Category: Tutorials"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tutorials</font></font></a></li><li><a href="https://www.lowlevel.eu/wiki/Kategorie:Netzwerkkarte" title="Category: Network Card"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">network card</font></font></a></li></ul></div></div><!-- end content --><div class="visualClear"></div></div></div></div><div id="column-one" lang="de" dir="ltr"><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Navigation menu</font></font></h2><div role="navigation" class="portlet" id="p-cactions" aria-labelledby="p-cactions-label"><h3 id="p-cactions-label" lang="de" dir="ltr"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Views</font></font></h3><div class="pBody"><ul lang="de" dir="ltr"><li id="ca-nstab-main" class="selected"><a href="https://www.lowlevel.eu/wiki/RTL8139" title="Show page content [alt-shift-c]" accesskey="c"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">page</font></font></a></li><li id="ca-talk"><a href="https://www.lowlevel.eu/wiki/Diskussion:RTL8139" rel="discussion" title="Discussion about page content [alt-shift-t]" accesskey="t"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">discussion</font></font></a></li><li id="ca-viewsource"><a href="https://www.lowlevel.eu/w/index.php?title=RTL8139&amp;action=edit" title="This site is protected.  Your source text can still be viewed and copied.  [alt-shift-e]" accesskey="e"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Show source code</font></font></a></li><li id="ca-history"><a href="https://www.lowlevel.eu/w/index.php?title=RTL8139&amp;action=history" title="Earlier versions of this page [alt-shift-h]" accesskey="h"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">history</font></font></a></li></ul></div></div><div role="navigation" class="portlet" id="p-personal" aria-labelledby="p-personal-label"><h3 id="p-personal-label" lang="de" dir="ltr"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">My tools</font></font></h3><div class="pBody"><ul lang="de" dir="ltr"><li id="pt-login"><a href="https://www.lowlevel.eu/w/index.php?title=Spezial:Anmelden&amp;returnto=RTL8139" title="It is welcome to register, but it is not mandatory.  [alt-shift-o]" accesskey="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">register</font></font></a></li></ul></div></div><div class="portlet" id="p-logo" role="banner"><a href="https://www.lowlevel.eu/wiki/Hauptseite" class="mw-wiki-logo" title="Main page"></a></div><div role="navigation" class="portlet generated-sidebar" id="p-navigation" aria-labelledby="p-navigation-label"><h3 id="p-navigation-label" lang="de" dir="ltr"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">navigation</font></font></h3><div class="pBody"><ul lang="de" dir="ltr"><li id="n-mainpage"><a href="https://www.lowlevel.eu/wiki/Hauptseite" title="Show main page [alt-shift-z]" accesskey="z"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Main page</font></font></a></li><li id="n-Lowlevel-Portal"><a href="https://www.lowlevel.eu/wiki/Lowlevel:Portal"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Low level portal</font></font></a></li><li id="n-Lowlevel-Forum"><a href="http://forum.lowlevel.eu/" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Low level forum</font></font></a></li><li id="n-recentchanges"><a href="https://www.lowlevel.eu/wiki/Spezial:Letzte_%C3%84nderungen" title="List of recent changes in this wiki [alt-shift-r]" accesskey="r"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">last changes</font></font></a></li><li id="n-Zuf.C3.A4llige-Seite"><a href="https://www.lowlevel.eu/wiki/Spezial:Zuf%C3%A4llige_Seite"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Random page</font></font></a></li><li id="n-Wiki-Crashkurs"><a href="https://www.lowlevel.eu/wiki/Wiki-Crashkurs"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wiki crash course</font></font></a></li></ul></div></div><div role="search" class="portlet" id="p-search"><h3 id="p-search-label" lang="de" dir="ltr"><label for="searchInput"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">search</font></font></label></h3><div class="pBody" id="searchBody"><form action="https://www.lowlevel.eu/w/index.php" id="searchform"><input type="hidden" value="Spezial:Suche" name="title"><input type="search" name="search" placeholder="Search low level" title="Search Lowlevel [alt-shift-f]" accesskey="f" id="searchInput" autocomplete="off"><font style="vertical-align: inherit;"></font>&nbsp; <font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><input type="submit" name="fulltext" value="Search " title="Search for pages that contain this text" id="mw-searchButton" class="searchButton"></font><font style="vertical-align: inherit;"><input type="submit" name="go" value="page" title="Go directly to the page with that exact name, if it exists." id="searchGoButton" class="searchButton"></font></font></form></div></div><div role="navigation" class="portlet" id="p-tb" aria-labelledby="p-tb-label"><h3 id="p-tb-label" lang="de" dir="ltr"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tools</font></font></h3><div class="pBody"><ul lang="de" dir="ltr"><li id="t-whatlinkshere"><a href="https://www.lowlevel.eu/wiki/Spezial:Linkliste/RTL8139" title="List of all pages that link here [alt-shift-j]" accesskey="j"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Links to this page</font></font></a></li><li id="t-recentchangeslinked"><a href="https://www.lowlevel.eu/wiki/Spezial:%C3%84nderungen_an_verlinkten_Seiten/RTL8139" rel="nofollow" title="Latest changes to pages linked from here [alt-shift-k]" accesskey="k"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Changes to linked pages</font></font></a></li><li id="t-specialpages"><a href="https://www.lowlevel.eu/wiki/Spezial:Spezialseiten" title="List of all special pages [alt-shift-q]" accesskey="q"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Special pages</font></font></a></li><li id="t-print"><a href="https://www.lowlevel.eu/w/index.php?title=RTL8139&amp;printable=yes" rel="alternate" title="Print view of this page [alt-shift-p]" accesskey="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Printable version</font></font></a></li><li id="t-permalink"><a href="https://www.lowlevel.eu/w/index.php?title=RTL8139&amp;oldid=11297" title="Permanent link to this page version"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Permanent link</font></font></a></li><li id="t-info"><a href="https://www.lowlevel.eu/w/index.php?title=RTL8139&amp;action=info" title="More information on this page"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Page information</font></font></a></li></ul></div></div><div role="navigation" class="portlet" id="p-lang" aria-labelledby="p-lang-label"><h3 id="p-lang-label" lang="de" dir="ltr"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In other languages</font></font></h3><div class="pBody"><ul lang="de" dir="ltr"><li class="interlanguage-link interwiki-en"><a href="http://wiki.osdev.org/RTL8139" title="RTL8139 - English" lang="en" hreflang="en" class="interlanguage-link-target"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">English</font></font></a></li></ul></div></div></div><!-- end of the left (by default at least) column --><div class="visualClear"></div><div id="footer" role="contentinfo" lang="de" dir="ltr"><div id="f-copyrightico" class="footer-icons"><a href="https://creativecommons.org/licenses/by-nc-sa/3.0/de/"><img src="./RTL8139__LowLevel_EnUs_files/88x31.png" alt="Attribution - No commercial use - Share alike 3.0 Germany" width="88" height="31"></a></div><div id="f-poweredbyico" class="footer-icons"><a href="https://www.mediawiki.org/"><img src="./RTL8139__LowLevel_EnUs_files/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" srcset="/w/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /w/resources/assets/poweredby_mediawiki_176x62.png 2x" width="88" height="31"></a></div><ul id="f-list"><li id="lastmod"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> This page was last edited on 9 October 2015, at 18:00.</font></font></li><li id="copyright"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The content is available under the </font></font><a class="external" rel="nofollow" href="https://creativecommons.org/licenses/by-nc-sa/3.0/de/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attribution</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> license </font><a class="external" rel="nofollow" href="https://creativecommons.org/licenses/by-nc-sa/3.0/de/"><font style="vertical-align: inherit;">- No commercial use - Share alike 3.0 Germany</font></a><font style="vertical-align: inherit;"> unless otherwise stated.</font></font></li><li id="privacy"><a href="https://www.lowlevel.eu/wiki/Lowlevel:Datenschutz" title="Lowlevel: data protection"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">privacy</font></font></a></li><li id="about"><a href="https://www.lowlevel.eu/wiki/Lowlevel:%C3%9Cber_Lowlevel" title="Lowlevel: About lowlevel"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About low level</font></font></a></li><li id="disclaimer"><a href="https://www.lowlevel.eu/wiki/Lowlevel:Impressum" title="Lowlevel: Imprint"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Disclaimer of liability</font></font></a></li></ul></div></div><script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgPageParseReport":{"limitreport":{"cputime":"0.008","walltime":"0.007","ppvisitednodes":{"value":56,"limit":1000000},"ppgeneratednodes":{"value":84,"limit":1000000},"postexpandincludesize":{"value":0,"limit":2097152},"templateargumentsize":{"value":0,"limit":2097152},"expansiondepth":{"value":2,"limit":40},"expensivefunctioncount":{"value":0,"limit":100},"unstrip-depth":{"value":0,"limit":20},"unstrip-size":{"value":209,"limit":5000000},"timingprofile":["100.00%    0.000      1 -total"]},"cachereport":{"timestamp":"20200512121826","ttl":86400,"transientcontent":false}}});});</script><script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({"wgBackendResponseTime":163});});</script><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="./RTL8139__LowLevel_EnUs_files/translate_24dp.png" width="20" height="20" alt="Google Tradutor"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Texto original</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Sugerir uma tradução melhor</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div><div class="suggestions" style="display: none; font-size: 11.4617px;"><div class="suggestions-results"></div><div class="suggestions-special"></div></div><div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div></body></html>