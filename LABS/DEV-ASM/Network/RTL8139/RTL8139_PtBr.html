<!DOCTYPE html>
<!-- saved from url=(0077)https://www.wfbsoftware.de/2019/07/22/realtek-rtl8139-network-interface-card/ -->
<html lang="pt" slick-uniqueid="3" class="translated-ltr"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	
	<meta name="viewport" content="width=device-width">
	<title>Placa de interface de rede Realtek rtl8139 |  wfbsoftware</title>
	<link rel="profile" href="http://gmpg.org/xfn/11">
	<link rel="pingback" href="https://www.wfbsoftware.de/xmlrpc.php">
	<!--[if lt IE 9]>
	<script src="https://www.wfbsoftware.de/wp-content/themes/twentythirteen/js/html5.js"></script>
	<![endif]-->
	<link rel="dns-prefetch" href="https://fonts.googleapis.com/">
<link rel="dns-prefetch" href="https://s.w.org/">
<link href="https://fonts.gstatic.com/" crossorigin="" rel="preconnect">
<link rel="alternate" type="application/rss+xml" title="wfbsoftware »Alimentação" href="https://www.wfbsoftware.de/feed/">
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/www.wfbsoftware.de\/wp-includes\/js\/wp-emoji-release.min.js?ver=5.0"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56760,9792,65039],[55358,56760,8203,9792,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script><script src="./RTL8139_PtBr_files/wp-emoji-release.min.js.download" type="text/javascript" defer=""></script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel="stylesheet" id="wp-block-library-css" href="./RTL8139_PtBr_files/style.min.css" type="text/css" media="all">
<link rel="stylesheet" id="wp-block-library-theme-css" href="./RTL8139_PtBr_files/theme.min.css" type="text/css" media="all">
<link rel="stylesheet" id="twentythirteen-fonts-css" href="./RTL8139_PtBr_files/css" type="text/css" media="all">
<link rel="stylesheet" id="genericons-css" href="./RTL8139_PtBr_files/genericons.css" type="text/css" media="all">
<link rel="stylesheet" id="twentythirteen-style-css" href="./RTL8139_PtBr_files/style.css" type="text/css" media="all">
<link rel="stylesheet" id="twentythirteen-block-style-css" href="./RTL8139_PtBr_files/blocks.css" type="text/css" media="all">
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentythirteen-ie-css'  href='https://www.wfbsoftware.de/wp-content/themes/twentythirteen/css/ie.css?ver=2013-07-18' type='text/css' media='all' />
<![endif]-->
<link rel="stylesheet" id="enlighter-local-css" href="./RTL8139_PtBr_files/EnlighterJS.min.css" type="text/css" media="all">
<script type="text/javascript" src="./RTL8139_PtBr_files/jquery.js.download"></script>
<script type="text/javascript" src="./RTL8139_PtBr_files/jquery-migrate.min.js.download"></script>
<link rel="https://api.w.org/" href="https://www.wfbsoftware.de/wp-json/">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://www.wfbsoftware.de/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://www.wfbsoftware.de/wp-includes/wlwmanifest.xml"> 
<link rel="prev" title="Teste de unidade C com cmocka" href="https://www.wfbsoftware.de/2019/07/18/c-unit-testing-with-cmocka/">
<link rel="next" title="ARP da pilha TCP / IP" href="https://www.wfbsoftware.de/2019/07/22/tcp-ip-stack/">
<meta name="generator" content="WordPress 5.0">
<link rel="canonical" href="https://www.wfbsoftware.de/2019/07/22/realtek-rtl8139-network-interface-card/">
<link rel="shortlink" href="https://www.wfbsoftware.de/?p=448">
<link rel="alternate" type="application/json+oembed" href="https://www.wfbsoftware.de/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fwww.wfbsoftware.de%2F2019%2F07%2F22%2Frealtek-rtl8139-network-interface-card%2F">
<link rel="alternate" type="text/xml+oembed" href="https://www.wfbsoftware.de/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fwww.wfbsoftware.de%2F2019%2F07%2F22%2Frealtek-rtl8139-network-interface-card%2F&amp;format=xml">
	<style type="text/css" id="twentythirteen-header-css">
		.site-header {
		background: url(https://www.wfbsoftware.de/wp-content/themes/twentythirteen/images/headers/circle.png) no-repeat scroll top;
		background-size: 1600px auto;
	}
	@media (max-width: 767px) {
		.site-header {
			background-size: 768px auto;
		}
	}
	@media (max-width: 359px) {
		.site-header {
			background-size: 360px auto;
		}
	}
			</style>
	<link type="text/css" rel="stylesheet" charset="UTF-8" href="./RTL8139_PtBr_files/translateelement.css"></head>

<body class="post-template-default single single-post postid-448 single-format-standard wp-embed-responsive single-author">
		<div id="page" class="hfeed site">
		<header id="masthead" class="site-header" role="banner">
			<a class="home-link" href="https://www.wfbsoftware.de/" title="wfbsoftware" rel="home">
				<h1 class="site-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wfbsoftware</font></font></h1>
				<h2 class="site-description"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aprenda algo novo todos os dias!</font></font></h2>
			</a>

			<div id="navbar" class="navbar">
				<nav id="site-navigation" class="navigation main-navigation" role="navigation">
					<button class="menu-toggle"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cardápio</font></font></button>
					<a class="screen-reader-text skip-link" href="https://www.wfbsoftware.de/2019/07/22/realtek-rtl8139-network-interface-card/#content" title="Ir para o conteúdo"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ir para o conteúdo</font></font></a>
					<div class="menu-default-menu-container"><ul id="primary-menu" class="nav-menu"><li id="menu-item-72" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-72"><a href="https://www.wfbsoftware.de/about-me/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sobre mim</font></font></a></li>
</ul></div>					<form role="search" method="get" class="search-form" action="https://www.wfbsoftware.de/">
				<label>
					<span class="screen-reader-text"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Procurar por:</font></font></span>
					<input type="search" class="search-field" placeholder="Pesquisar…" value="" name="s">
				</label>
				<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"><input type="submit" class="search-submit" value="Procurar"></font></font>
			</form>				</nav><!-- #site-navigation -->
			</div><!-- #navbar -->
		</header><!-- #masthead -->

		<div id="main" class="site-main">

	<div id="primary" class="content-area">
		<div id="content" class="site-content" role="main">

						
				
<article id="post-448" class="post-448 post type-post status-publish format-standard hentry category-c-2 category-driver-development category-networkprogramming category-operatingsystems">
	<header class="entry-header">
		
				<h1 class="entry-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Placa de interface de rede Realtek rtl8139</font></font></h1>
		
		<div class="entry-meta">
			<span class="date"><a href="https://www.wfbsoftware.de/2019/07/22/realtek-rtl8139-network-interface-card/" title="Permalink to Placa de interface de rede Realtek rtl8139" rel="bookmark"><time class="entry-date" datetime="2019-07-22T13:32:02+00:00"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">22 de julho de 2019</font></font></time></a></span><span class="categories-links"><a href="https://www.wfbsoftware.de/category/c-2/" rel="category tag"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://www.wfbsoftware.de/category/c-2/driver-development/" rel="category tag"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desenvolvimento de drivers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="https://www.wfbsoftware.de/category/networkprogramming/" rel="category tag"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programação de rede</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><a href="https://www.wfbsoftware.de/category/networkprogramming/" rel="category tag"><font style="vertical-align: inherit;">Sistemas </font></a></font><a href="https://www.wfbsoftware.de/category/operatingsystems/" rel="category tag"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">operacionais</font></font></a></span><span class="author vcard"><a class="url fn n" href="https://www.wfbsoftware.de/author/wbi/" title="Ver todas as mensagens de wbi" rel="author"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wbi</font></font></a></span>					</div><!-- .entry-meta -->
	</header><!-- .entry-header -->

		<div class="entry-content">
		
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Introdução</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta publicação explica tudo o que sei sobre o desenvolvimento de um driver para o adaptador de rede Realtek rtl8139. </font><font style="vertical-align: inherit;">É uma placa de interface de rede capaz de velocidades de rede de 10/100 Mbit / s. </font><font style="vertical-align: inherit;">É emulado pelo qemu, o que o torna um alvo principal para aprender sobre o desenvolvimento de drivers.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para habilitar o rtl8139 no qemu, use</font></font></p>
<pre class="EnlighterJSRAW" data-enlighter-language="shell" style="display: none;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qemu-system-i386 -net nic, model = rtl8139 -fda &lt;seu_image&gt;</font></font></pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qemu-system-i386 -net nic, model = rtl8139 -fda &lt;seu_image&gt;</font></font></span></li></ol><pre style="display: none;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">qemu-system-i386 -net nic, model = rtl8139 -fda &lt;seu_image&gt;</font></font></pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="Marcador de sintaxe JS"></a><a class="EnlighterJSRawButton" title="Alternar código RAW"></a><a class="EnlighterJSWindowButton" title="Abrir código em uma nova janela"></a><span class="clear"></span></div></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O </font></font><a href="https://wiki.osdev.org/RTL8139"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wiki do osdev</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> diz:</font></font></p>
<blockquote>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se você encontrar seu driver de repente congela e para de receber interrupções e você está usando o kvm / qemu. </font><font style="vertical-align: inherit;">Experimente a opção -no-kvm-irqchip</font></font></p>
</blockquote>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ligações</font></font></h3>
<ul>
<li><a href="https://github.com/lentinj/u-boot/blob/master/drivers/net/rtl8139.c"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://github.com/lentinj/u-boot/blob/master/drivers/net/rtl8139.c</font></font></a></li>
<li><a href="https://wiki.osdev.org/RTL8139"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://wiki.osdev.org/RTL8139</font></font></a></li>
<li><a href="https://www.realtek.com/en/component/zoo/category/network-interface-controllers-10-100-1000m-gigabit-ethernet-pci-express-software"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Realtek</font></font></a></li>
<li><a href="https://ftp.gwdg.de/pub/linux/tux/net/donald-becker/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Página de Donald Becker</font></font></a></li>
</ul>
<h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Processo de Inicialização</font></font></h3>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para inicializar a placa de rede, existem várias configurações a serem definidas. </font><font style="vertical-align: inherit;">Existem dois tipos de locais onde as configurações devem ser aplicadas:</font></font></p>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espaço de configuração do PCI</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioaddr</font></font></li>
</ol>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Localizando o dispositivo no sistema</font></font></h5>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O rtl8139 está conectado ao </font></font><a href="https://wiki.osdev.org/PCI"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">barramento PCI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Com o PCI, cada dispositivo é identificado por um par de IDs. </font><font style="vertical-align: inherit;">O par consiste em um ID do fornecedor e um ID do dispositivo. </font><font style="vertical-align: inherit;">O rtl8139 possui um ID de fornecedor </font></font><code>0x10ec</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e um ID de dispositivo </font></font><code>0x8139</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Você pode verificar qualquer par de ID de fornecedor e ID de dispositivo em </font></font><a href="https://www.pcilookup.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://www.pcilookup.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><a href="http://pciengine.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://pciengine.com/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primeiro, você deve verificar se o sistema possui o rtl8139 (ou se o qemu simula a placa) listando todos os dispositivos PCI do sistema e procurando o fornecedor e o ID do dispositivo. </font><font style="vertical-align: inherit;">A lista de dispositivos PCI é descrita </font></font><a href="http://anadoxin.org/blog/pci-device-enumeration-using-ports-0xcf8-0xcfc.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></p>
<h6><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espaço de configuração do PCI</font></font></h6>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O PCI (Peripheral Component Interconnect) é uma maneira de configurar o hardware com base em software puro. </font><font style="vertical-align: inherit;">As placas de extensão que você coloca no seu PC através de um slot PCI fazem parte do sistema PCI.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um sistema PCI consiste em até 256 barramentos, cada barramento pode conter até 32 dispositivos, cada dispositivo pode ser um pacote de até 8 funções. </font><font style="vertical-align: inherit;">Isso significa que uma placa de extensão PCI pode atuar como até 8 dispositivos quando conectada ao PC. </font><font style="vertical-align: inherit;">Cada um desses dispositivos terá sua própria função via PCI.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um PC geralmente contém apenas um único barramento PCI; portanto, em vez de usar 256 barramentos, ele contém apenas 1.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma dessas funções em um dos dispositivos em um dos ônibus será o RTL 8139, mas não está predefinido qual é. </font><font style="vertical-align: inherit;">Isso significa que a tupla de (barramento, dispositivo, função) é desconhecida e o motorista precisa encontrar o dispositivo.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para encontrar o toque, existem várias maneiras de fazê-lo. </font><font style="vertical-align: inherit;">A maneira mais simples é repetir todos os barramentos, dispositivos e funções. </font><font style="vertical-align: inherit;">Em cada função, usando o toque atual (barramento, dispositivo, função), é possível ler os dados do dispositivo nessas coordenadas. </font><font style="vertical-align: inherit;">Se o toque não apontar para um dispositivo existente, continue com o toque seguinte. </font><font style="vertical-align: inherit;">Se houver um dispositivo ao toque, é possível ler o chamado espaço de configuração PCI desse dispositivo. </font><font style="vertical-align: inherit;">O espaço de configuração contém vários registros no hardware PCI. </font><font style="vertical-align: inherit;">Dois registros importantes são o fornecedor e o dispositivo.</font></font></p>
<p><a href="https://en.wikipedia.org/wiki/PCI_configuration_space"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> está uma descrição geral do espaço de configuração PCI da placa PCI. </font><font style="vertical-align: inherit;">Você pode ver que os quatro primeiros bytes contêm o ID do fornecedor e o ID do dispositivo.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A leitura e gravação do espaço de configuração do PCI são feitas via portas. </font><font style="vertical-align: inherit;">Uma porta é um endereço de memória que aponta para o hardware em vez de para uma célula de memória. </font><font style="vertical-align: inherit;">As portas podem ser usadas para gravar e ler dados e se comunicar com o hardware, em vez de gravar e ler na memória. </font><font style="vertical-align: inherit;">Primeiro, você deve especificar o endereço que deseja manipular gravando dados no endereço de configuração 0xCF8. </font><font style="vertical-align: inherit;">Depois que esse local é configurado, você pode ler ou gravar dados lendo e gravando no endereço de dados de configuração 0xCFC.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O RTL 8319 (e todas as placas PCI) possui valores específicos para fornecedor e dispositivo. </font><font style="vertical-align: inherit;">Conhecendo esses valores, o cartão pode ser identificado e o toque (barramento, dispositivo, função) pode ser encontrado.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tendo o toque (barramento, dispositivo, função), o driver pode começar com a configuração.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O código para iterar e encontrar o RTL 8139 está listado aqui:</font></font></p>
<pre class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">const u32int PCI_ENABLE_BIT = 0x80000000;
const u32int PCI_CONFIG_ADDRESS = 0xCF8;
const u32int PCI_CONFIG_DATA = 0xCFC;

// func - 0-7
// slot - 0-31
// bus - 0-255
//
// described here: https://en.wikipedia.org/wiki/PCI_configuration_space under
// the section "software implementation"
// parameter pcireg: 0 will read the first 32bit dword of the pci control space
// which is DeviceID and Vendor ID
// pcireg = 1 will read the second 32bit dword which is status and command
// and so on...
u32int r_pci_32(u8int bus, u8int device, u8int func, u8int pcireg) {

  // compute the index
  //
  // pcireg is left shifted twice to multiply it by 4 because each register
  // is 4 byte long (32 bit registers)
  u32int index = PCI_ENABLE_BIT | (bus &lt;&lt; 16) | (device &lt;&lt; 11) | (func &lt;&lt; 8) |
                 (pcireg &lt;&lt; 2);

  // write the index value onto the index port
  outl(index, PCI_CONFIG_ADDRESS);

  // read a value from the data port
  return inl(PCI_CONFIG_DATA);
}

int realtek8319Found = 0;

unsigned char pci_bus = 0;
unsigned char pci_device = 0;
unsigned char pci_device_fn = 0;

// there are 256 busses allowed
for (bus = 0; bus != 0xff; bus++) {

// per bus there can be at most 32 devices
for (device = 0; device &lt; 32; device++) {

  // every device can be multi function device of up to 8 functions
  for (func = 0; func &lt; 8; func++) {

    // read the first dword (index 0) from the PCI configuration space
    // dword 0 contains the vendor and device values from the PCI configuration space
    data = r_pci_32(bus, device, func, 0);
    if (data != 0xffffffff) {
       
       // parse the values
       u16int device_value = (data &gt;&gt; 16);
       u16int vendor = data &amp; 0xFFFF;

       // check vendor and device against the values of the RTL 8139 PCI device
       realtek8319Found = 0;
       if (vendor == 0x10ec &amp;&amp; device_value == 0x8139) {

        realtek8319Found = 1;

        pci_bus = bus;
        pci_device = device;
        pci_device_fn = func;

        k_printf("RTL8139 found! bus: %d", pci_bus);
        k_printf(" device: %d", pci_device);
        k_printf(" func: %d \n", pci_device_fn);
      }

    }
  }
}</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">const </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">u32int PCI_ENABLE_BIT = </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x80000000 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">const </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">u32int PCI_CONFIG_ADDRESS = </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0xCF8 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">const </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">u32int PCI_CONFIG_DATA = </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0xCFC </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span><span class="co1"></span></li><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// func - 0-7</font></font></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// slot - 0-31</font></font></span><span class="co1"></span></li><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// ônibus - 0-255</font></font></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">//</font></font></span><span class="co1"></span></li><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// descrito aqui: https://en.wikipedia.org/wiki/PCI_configuration_space em</font></font></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// a seção "implementação de software"</font></font></span><span class="co1"></span></li><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// parâmetro pcireg: 0 lerá o primeiro dword de 32 bits do espaço de controle pci</font></font></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// que é DeviceID e ID do fornecedor</font></font></span><span class="co1"></span></li><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// pcireg = 1 lerá o segundo dword de 32 bits, que é status e comando</font></font></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// e assim por diante...</font></font></span><span class=""></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">u32int </font></font></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r_pci_32 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">barramento u8int, dispositivo u8int, função u8int, pcireg u8int </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><font style="vertical-align: inherit;"><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""> </span><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> // computa o índice</font></font></span><span class=""></span></li><li class=" even"><span class=""> </span><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> //</font></font></span><span class=""></span></li><li class=" odd"><span class=""> </span><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> // pcireg é deixado deslocado duas vezes para multiplicá-lo por 4 porque cada registro</font></font></span><span class=""></span></li><li class=" even"><span class=""> </span><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> // tem 4 bytes de comprimento (registradores de 32 bits)</font></font></span><span class=""></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">  Índice u32int = PCI_ENABLE_BIT | </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ônibus &lt;&lt; </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">| </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dispositivo &lt;&lt; </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">11 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">| </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">func &lt;&lt; </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">|</font></font></span></li><li class=" even"><span class="">                 </span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pcireg &lt;&lt; </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""> </span><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> // grava o valor do índice na porta de índice</font></font></span><span class=""></span></li><li class=" odd"><span class="">  </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outl </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">índice, PCI_CONFIG_ADDRESS </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""> </span><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> // lê um valor da porta de dados</font></font></span><span class=""></span></li><li class=" even"><span class="">  </span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retorno </font></font></span><font style="vertical-align: inherit;"><span class="de1"><font style="vertical-align: inherit;">inl </font></span><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class=""><font style="vertical-align: inherit;">PCI_CONFIG_DATA </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class=""><font style="vertical-align: inherit;">;</font></span></font><span class=""> </span><span class="de1"><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span></li><li class=" odd"><span class=""></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">}</font></font></span><span class=""></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">realtek8319Found = </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"><span class="kw1"><font style="vertical-align: inherit;">char </font></span><span class="kw1"><font style="vertical-align: inherit;">não assinado </font></span><span class=""><font style="vertical-align: inherit;">pci_bus = </font></span><span class="nu0"><font style="vertical-align: inherit;">0 </font></span><span class=""><font style="vertical-align: inherit;">;</font></span></font><span class=""> </span><span class="kw1"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span></li><li class=" even"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"><span class="kw1"><font style="vertical-align: inherit;">char </font></span><span class="kw1"><font style="vertical-align: inherit;">não assinado </font></span><span class=""><font style="vertical-align: inherit;">pci_device = </font></span><span class="nu0"><font style="vertical-align: inherit;">0 </font></span><span class=""><font style="vertical-align: inherit;">;</font></span></font><span class=""> </span><span class="kw1"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span></li><li class=" odd"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"><span class="kw1"><font style="vertical-align: inherit;">char </font></span><span class="kw1"><font style="vertical-align: inherit;">não assinado </font></span><span class=""><font style="vertical-align: inherit;">pci_device_fn = </font></span><span class="nu0"><font style="vertical-align: inherit;">0 </font></span><span class=""><font style="vertical-align: inherit;">;</font></span></font><span class=""> </span><span class="kw1"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span></li><li class=" even"><span class=""></span><span class="co1"></span></li><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// são permitidos 256 barramentos</font></font></span><span class=""></span></li><li class=" even"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for </font></font></span><font style="vertical-align: inherit;"><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class=""><font style="vertical-align: inherit;">barramento = </font></span><span class="nu0"><font style="vertical-align: inherit;">0 </font></span><span class=""><font style="vertical-align: inherit;">; barramento! = </font></span><span class="nu0"><font style="vertical-align: inherit;">0xff </font></span><span class=""><font style="vertical-align: inherit;">; barramento ++ </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" odd"><span class=""></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// por barramento, pode haver no máximo 32 dispositivos</font></font></span><span class=""></span></li><li class=" odd"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para </font></font></span><font style="vertical-align: inherit;"><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class=""><font style="vertical-align: inherit;">dispositivo = </font></span><span class="nu0"><font style="vertical-align: inherit;">0 </font></span><span class=""><font style="vertical-align: inherit;">; dispositivo &lt; </font></span><span class="nu0"><font style="vertical-align: inherit;">32 </font></span><span class=""><font style="vertical-align: inherit;">; dispositivo ++ </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""> </span><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> // todo dispositivo pode ser multifuncional com até 8 funções</font></font></span><span class=""></span></li><li class=" even"><span class="">  </span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para </font></font></span><font style="vertical-align: inherit;"><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class=""><font style="vertical-align: inherit;">func = </font></span><span class="nu0"><font style="vertical-align: inherit;">0 </font></span><span class=""><font style="vertical-align: inherit;">; func &lt; </font></span><span class="nu0"><font style="vertical-align: inherit;">8 </font></span><span class=""><font style="vertical-align: inherit;">; func ++ </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">   </span><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> // lê o primeiro dword (índice 0) no espaço de configuração do PCI</font></font></span><span class=""></span></li><li class=" odd"><span class="">   </span><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> // dword 0 contém os valores do fornecedor e do dispositivo do espaço de configuração do PCI</font></font></span><span class=""></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">    data = </font></font></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r_pci_32 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">barramento, dispositivo, função, </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class="">    </span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if </font></font></span><font style="vertical-align: inherit;"><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class=""><font style="vertical-align: inherit;">data! = </font></span><span class="nu0"><font style="vertical-align: inherit;">0xffffffff </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" even"><span class="">       </span></li><li class=" odd"><span class="">      </span><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> // analisa os valores</font></font></span><span class=""></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">       u16int device_value = </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dados &gt;&gt; </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">       fornecedor u16int = dados &amp; </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0xFFFF </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">      </span><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> // verifique o fornecedor e o dispositivo em relação aos valores do dispositivo PCI RTL 8139</font></font></span><span class=""></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">       realtek8319Found = </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class="">       </span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if </font></font></span><font style="vertical-align: inherit;"><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class=""><font style="vertical-align: inherit;">fornecedor == </font></span><span class="nu0"><font style="vertical-align: inherit;">0x10ec </font></span><span class=""><font style="vertical-align: inherit;">&amp;&amp; device_value == </font></span><span class="nu0"><font style="vertical-align: inherit;">0x8139 </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">        realtek8319Found = </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">        pci_bus = barramento;</font></font></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">        pci_device = dispositivo;</font></font></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">        pci_device_fn = func;</font></font></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">        </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k_printf </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"RTL8139 encontrado! barramento:% d" </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, pci_bus </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class="">        </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k_printf </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"dispositivo:% d" </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, pci_device </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class="">        </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k_printf </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"func:% d \ n" </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, pci_device_fn </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class="">      </span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">}</font></font></span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">    </span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">}</font></font></span><span class=""></span></li><li class=" odd"><span class="">  </span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">}</font></font></span><span class=""></span></li><li class=" even"><span class=""></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">}</font></font></span></li></ol><pre style="display: none;">const u32int PCI_ENABLE_BIT = 0x80000000;
const u32int PCI_CONFIG_ADDRESS = 0xCF8;
const u32int PCI_CONFIG_DATA = 0xCFC;

// func - 0-7
// slot - 0-31
// bus - 0-255
//
// described here: https://en.wikipedia.org/wiki/PCI_configuration_space under
// the section "software implementation"
// parameter pcireg: 0 will read the first 32bit dword of the pci control space
// which is DeviceID and Vendor ID
// pcireg = 1 will read the second 32bit dword which is status and command
// and so on...
u32int r_pci_32(u8int bus, u8int device, u8int func, u8int pcireg) {

  // compute the index
  //
  // pcireg is left shifted twice to multiply it by 4 because each register
  // is 4 byte long (32 bit registers)
  u32int index = PCI_ENABLE_BIT | (bus &lt;&lt; 16) | (device &lt;&lt; 11) | (func &lt;&lt; 8) |
                 (pcireg &lt;&lt; 2);

  // write the index value onto the index port
  outl(index, PCI_CONFIG_ADDRESS);

  // read a value from the data port
  return inl(PCI_CONFIG_DATA);
}

int realtek8319Found = 0;

unsigned char pci_bus = 0;
unsigned char pci_device = 0;
unsigned char pci_device_fn = 0;

// there are 256 busses allowed
for (bus = 0; bus != 0xff; bus++) {

// per bus there can be at most 32 devices
for (device = 0; device &lt; 32; device++) {

  // every device can be multi function device of up to 8 functions
  for (func = 0; func &lt; 8; func++) {

    // read the first dword (index 0) from the PCI configuration space
    // dword 0 contains the vendor and device values from the PCI configuration space
    data = r_pci_32(bus, device, func, 0);
    if (data != 0xffffffff) {
       
       // parse the values
       u16int device_value = (data &gt;&gt; 16);
       u16int vendor = data &amp; 0xFFFF;

       // check vendor and device against the values of the RTL 8139 PCI device
       realtek8319Found = 0;
       if (vendor == 0x10ec &amp;&amp; device_value == 0x8139) {

        realtek8319Found = 1;

        pci_bus = bus;
        pci_device = device;
        pci_device_fn = func;

        k_printf("RTL8139 found! bus: %d", pci_bus);
        k_printf(" device: %d", pci_device);
        k_printf(" func: %d \n", pci_device_fn);
      }

    }
  }
}</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>&nbsp;</p>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioaddr</font></font></h5>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se o Realtek 8139 for incorporado em um PC, ele recebe um ioaddr atribuído durante a inicialização do sistema. </font><font style="vertical-align: inherit;">O dispositivo é mapeado na memória nesse ioaddr. </font><font style="vertical-align: inherit;">Ao escrever ou ler dados da memória nesse ioaddr, o sistema operacional pode configurar o cartão.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O ioaddr pode ser lido no espaço de configuração do PCI no byte 4. O byte 4 é onde o registro de comandos é iniciado. </font><font style="vertical-align: inherit;">O ioaddr é armazenado nos três bits mais baixos do registro de comandos.</font></font></p>
<pre class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">// read the ioaddr/base_address
u32int pci_ioaddr = r_pci_32(pci_bus, pci_device, pci_device_fn, 4);
k_printf("pci_ioaddr: 0x%x \n", pci_ioaddr);

unsigned long ioaddr = pci_ioaddr &amp; ~3;
k_printf("ioaddr: 0x%x \n", ioaddr);</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// leia o ioaddr / base_address</font></font></span><span class=""></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">u32int pci_ioaddr = </font></font></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r_pci_32 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pci_bus, pci_device, pci_device_fn, </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k_printf </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"pci_ioaddr: 0x% x \ n" </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, pci_ioaddr </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"><span class=""><font style="vertical-align: inherit;">ioaddr </font></span><span class="kw1"><font style="vertical-align: inherit;">longo </font></span><span class="kw1"><font style="vertical-align: inherit;">não assinado </font></span><span class=""><font style="vertical-align: inherit;">= pci_ioaddr &amp; ~ </font></span><span class="nu0"><font style="vertical-align: inherit;">3 </font></span><span class=""><font style="vertical-align: inherit;">;</font></span></font><span class=""> </span><span class="kw1"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span></li><li class=" even"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k_printf </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"ioaddr: 0x% x \ n" </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ioaddr </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li></ol><pre style="display: none;">// read the ioaddr/base_address
u32int pci_ioaddr = r_pci_32(pci_bus, pci_device, pci_device_fn, 4);
k_printf("pci_ioaddr: 0x%x \n", pci_ioaddr);

unsigned long ioaddr = pci_ioaddr &amp; ~3;
k_printf("ioaddr: 0x%x \n", ioaddr);</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando o ioaddr, o driver pode ligar o cartão.</font></font></p>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ligando o cartão</font></font></h5>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Escreva o valor 0 no endereço config1 por meio do ioaddr.</font></font></p>
<pre class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">// write a byte out to the specified port.
void outb(u8int value, u16int port) {

  __asm__ __volatile__("outb %1, %0" : : "dN"(port), "a"(value));
}

outb(0x00, ioaddr + Config1);
k_printf("starting chip done.\n");</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// grava um byte na porta especificada.</font></font></span><span class=""></span></li><li class=" even"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">void </font></font></span><font style="vertical-align: inherit;"><span class="de1"><font style="vertical-align: inherit;">outb </font></span><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class=""><font style="vertical-align: inherit;">valor u8int, porta u16int </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="de1"><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">  __asm__ </font></font></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__volatile__ </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"outb% 1,% 0" </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:: </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"dN" </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">porta </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"a" </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">valor </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">}</font></font></span><span class=""></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outb </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x00 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ioaddr + Config1 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k_printf </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"chip inicial concluído. \ n" </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li></ol><pre style="display: none;">// write a byte out to the specified port.
void outb(u8int value, u16int port) {

  __asm__ __volatile__("outb %1, %0" : : "dN"(port), "a"(value));
}

outb(0x00, ioaddr + Config1);
k_printf("starting chip done.\n");</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Masterização de ônibus</font></font></h5>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O próximo passo é ativar o domínio do barramento. </font><font style="vertical-align: inherit;">Se você não ativar o master de barramento, o qemu não transferirá nenhum dado entre a memória do sistema operacional e a memória da placa de rede RTL 8139, mas, em vez disso, transferirá zeros.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma transferência de dados é necessária para enviar um pacote ou receber pacotes. </font><font style="vertical-align: inherit;">Para enviar um pacote, primeiro os dados são copiados da memória do sistema operacional para um buffer na placa PCI. </font><font style="vertical-align: inherit;">Do buffer, o cartão transfere os dados para o fio.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A transferência de dados é realizada via DMA (Direct Memory Access). </font><font style="vertical-align: inherit;">Se uma placa PCI não tiver direitos atribuídos ao mestre de barramento, ela não poderá executar o DMA. </font><font style="vertical-align: inherit;">Somente o mestre do barramento tem permissão para executar DMA. </font><font style="vertical-align: inherit;">(Nota: Foi relatado que em algum hardware real não é necessário habilitar o domínio do barramento. O qemu foi atualizado para tornar obrigatório o domínio do barramento. Se você testar no qemu, precisará desta etapa)</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se a masterização do barramento estiver desativada, o qemu não copiará nenhum dado no cartão, mas apenas zerará.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O mesmo vale para receber. </font><font style="vertical-align: inherit;">A placa PCI recebe dados do fio e grava esses dados em um buffer. </font><font style="vertical-align: inherit;">O sistema operacional copiará os dados do buffer na memória do sistema operacional via DMA. </font><font style="vertical-align: inherit;">Se a masterização do barramento estiver desativada, o qemu transferirá apenas zeros em vez dos dados reais.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para habilitar o master de barramento, é necessário definir o bit 3 (zero indexado, bit3 é realmente o quarto bit se você começar a contar de 1 em vez de 0) dentro do registro de comando.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O bit é definido lendo o registro de comando, lançando o bit 3 e escrevendo o valor de volta no registro de comando.</font></font></p>
<pre class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">// https://wiki.osdev.org/RTL8139
// enable bus mastering in the command register
// Some BIOS may enable Bus Mastering at startup, but some versions
// of qemu don't. You should thus be careful about this step.
k_printf("BUS mastering ...\n");

u16int command_register =
    pci_read_word(pci_bus, pci_device, pci_device_fn, 0x04);

k_printf("BUS mastering command_register = %x\n", command_register);

command_register |= 0x04;

pci_write_word(pci_bus, pci_device, pci_device_fn, 0x04, command_register);

command_register = pci_read_word(pci_bus, pci_device, pci_device_fn, 0x04);

k_printf("BUS mastering command_register = %x\n", command_register);</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// https://wiki.osdev.org/RTL8139</font></font></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// habilita a masterização do barramento no registro de comandos</font></font></span><span class="co1"></span></li><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// Alguns BIOS podem ativar o Bus Mastering na inicialização, mas algumas versões</font></font></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// do qemu não. </font><font style="vertical-align: inherit;">Portanto, você deve ter cuidado com esta etapa.</font></font></span><span class=""></span></li><li class=" odd"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k_printf </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"BUS masterizando ... \ n" </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">u16int command_register =</font></font></span></li><li class=" even"><span class="">    </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pci_read_word </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pci_bus, pci_device, pci_device_fn, </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x04 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k_printf </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"BUS masterizando command_register =% x \ n" </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, command_register </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">command_register | = </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x04 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pci_write_word </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pci_bus, pci_device, pci_device_fn, </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x04 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, command_register </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">command_register = </font></font></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pci_read_word </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pci_bus, pci_device, pci_device_fn, </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x04 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k_printf </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"BUS masterizando command_register =% x \ n" </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, command_register </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li></ol><pre style="display: none;">// https://wiki.osdev.org/RTL8139
// enable bus mastering in the command register
// Some BIOS may enable Bus Mastering at startup, but some versions
// of qemu don't. You should thus be careful about this step.
k_printf("BUS mastering ...\n");

u16int command_register =
    pci_read_word(pci_bus, pci_device, pci_device_fn, 0x04);

k_printf("BUS mastering command_register = %x\n", command_register);

command_register |= 0x04;

pci_write_word(pci_bus, pci_device, pci_device_fn, 0x04, command_register);

command_register = pci_read_word(pci_bus, pci_device, pci_device_fn, 0x04);

k_printf("BUS mastering command_register = %x\n", command_register);</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Redefinição de software</font></font></h5>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em seguida é uma redefinição de software</font></font></p>
<pre class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">// software reset
// https://wiki.osdev.org/RTL8139
// Sending 0x10 to the Command register (0x37) will send the RTL8139 into a
// software reset. Once that byte is sent, the RST bit must be checked to
// make sure that the chip has finished the reset. If the RST bit is high
// (1), then the reset is still in operation.

// ChipCmd is the Command Register 0x37 = 55
// 0x10 == 0001 0000 == bit 5
// k_printf("Reset the chip %d ...\n", i);
outb(0x10, ioaddr + ChipCmd);
while ((inb(ioaddr + ChipCmd) &amp; 0x10) != 0) {
  k_printf("waiting for reset!\n");
}
k_printf("Reset done.\n");</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// redefinição de software</font></font></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// https://wiki.osdev.org/RTL8139</font></font></span><span class="co1"></span></li><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// O envio de 0x10 para o registrador de comando (0x37) enviará o RTL8139 para um</font></font></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// reinicialização do software. </font><font style="vertical-align: inherit;">Depois que o byte é enviado, o bit RST deve ser verificado para</font></font></span><span class="co1"></span></li><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// verifique se o chip concluiu a redefinição. </font><font style="vertical-align: inherit;">Se o bit RST estiver alto</font></font></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// (1), a redefinição ainda está em operação.</font></font></span><span class=""></span></li><li class=" odd"><span class=""></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// ChipCmd é o registro de comando 0x37 = 55</font></font></span><span class="co1"></span></li><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// 0x10 == 0001 0000 == bit 5</font></font></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// k_printf ("Redefina o chip% d ... \ n", i);</font></font></span><span class=""></span></li><li class=" odd"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outb </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x10 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ioaddr + ChipCmd </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">while </font></font></span><font style="vertical-align: inherit;"><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class="de1"><font style="vertical-align: inherit;">inb </font></span><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class=""><font style="vertical-align: inherit;">ioaddr + ChipCmd </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class=""><font style="vertical-align: inherit;">e </font></span><span class="nu0"><font style="vertical-align: inherit;">0x10 </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class=""><font style="vertical-align: inherit;">! = </font></span><span class="nu0"><font style="vertical-align: inherit;">0 </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class="de1"><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" odd"><span class="">  </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k_printf </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"aguardando redefinição! \ n" </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">}</font></font></span><span class=""></span></li><li class=" odd"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k_printf </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Redefinição concluída. \ n" </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li></ol><pre style="display: none;">// software reset
// https://wiki.osdev.org/RTL8139
// Sending 0x10 to the Command register (0x37) will send the RTL8139 into a
// software reset. Once that byte is sent, the RST bit must be checked to
// make sure that the chip has finished the reset. If the RST bit is high
// (1), then the reset is still in operation.

// ChipCmd is the Command Register 0x37 = 55
// 0x10 == 0001 0000 == bit 5
// k_printf("Reset the chip %d ...\n", i);
outb(0x10, ioaddr + ChipCmd);
while ((inb(ioaddr + ChipCmd) &amp; 0x10) != 0) {
  k_printf("waiting for reset!\n");
}
k_printf("Reset done.\n");</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ativar receptor e transmissor</font></font></h5>
<pre class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">// enable receiver and transmitter
// Sets the RE and TE bits high
// k_printf("Enable receiver and transmitter %d...\n", i);
// 0x0C = 1100 = bit 2 und bit 3
outb(0x0C, ioaddr + ChipCmd);
k_printf("Enable receiver and transmitter done.\n");</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// habilita o receptor e o transmissor</font></font></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// Define os bits RE e TE altos</font></font></span><span class="co1"></span></li><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// k_printf ("Ativar receptor e transmissor% d ... \ n", i);</font></font></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// 0x0C = 1100 = bit 2 e bit 3</font></font></span><span class=""></span></li><li class=" odd"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outb </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x0C </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ioaddr + ChipCmd </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k_printf </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Ativar receptor e transmissor concluídos. \ n" </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li></ol><pre style="display: none;">// enable receiver and transmitter
// Sets the RE and TE bits high
// k_printf("Enable receiver and transmitter %d...\n", i);
// 0x0C = 1100 = bit 2 und bit 3
outb(0x0C, ioaddr + ChipCmd);
k_printf("Enable receiver and transmitter done.\n");</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Definir registros de configuração de transmissão e recebimento</font></font></h5>
<pre class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">// https://www.lowlevel.eu/wiki/RTL8139
// CR (Transmit Configuration Register, 0x40, 4 Bytes) und RCR
// (Receive Configuration Register, 0x44, 4 Bytes) setzen.
outl(0x03000700, ioaddr + TxConfig);
outl(0x0000070a, ioaddr + RxConfig);</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// https://www.lowlevel.eu/wiki/RTL8139</font></font></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// CR (registro de configuração de transmissão, 0x40, 4 bytes) e RCR</font></font></span><span class="co1"></span></li><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// (Registro de configuração de recebimento, 0x44, 4 bytes) setzen.</font></font></span><span class=""></span></li><li class=" even"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outl </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x03000700 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ioaddr + TxConfig </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outl </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x0000070a </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ioaddr + RxConfig </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li></ol><pre style="display: none;">// https://www.lowlevel.eu/wiki/RTL8139
// CR (Transmit Configuration Register, 0x40, 4 Bytes) und RCR
// (Receive Configuration Register, 0x44, 4 Bytes) setzen.
outl(0x03000700, ioaddr + TxConfig);
outl(0x0000070a, ioaddr + RxConfig);</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuração concluída</font></font></h5>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nesse ponto, o RTL 8139 está pronto para enviar e receber dados. </font><font style="vertical-align: inherit;">A seguir, o envio de dados é explicado.</font></font></p>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enviando dados</font></font></h5>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os dados a serem enviados são gravados em um buffer (matriz de bytes) na memória do sistema operacional. </font><font style="vertical-align: inherit;">Em seguida, o buffer é transferido para o cartão via DMA (e é por isso que o driver permite o domínio do barramento). </font><font style="vertical-align: inherit;">Você precisa especificar o endereço físico para o DMA! </font><font style="vertical-align: inherit;">A placa PCI não entende paginação! </font><font style="vertical-align: inherit;">Ele lê apenas da memória em locais físicos e não passa pela unidade de gerenciamento de memória.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Minha dica para você é desativar a paginação durante seus testes iniciais com o RTL 8139 apenas para descartar essa fonte de erro.</font></font></p>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TSAD e TSD</font></font></h5>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A maneira como o RTL 8139 aceita dados para envio é explicada nesta seção. </font><font style="vertical-align: inherit;">Em um nível mais abstrato, o cartão possui quatro buffers de hardware para envio. </font><font style="vertical-align: inherit;">Esses buffers também são chamados de descritores. </font><font style="vertical-align: inherit;">A qualquer momento, há apenas um único buffer de hardware ativo. </font><font style="vertical-align: inherit;">Após a redefinição do cartão durante a inicialização, o buffer com índice 0 é o buffer ativo.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O cartão enviará os dados armazenados no buffer de hardware ativo no momento e fará com que o próximo buffer de hardware na linha seja o buffer ativo. </font><font style="vertical-align: inherit;">Depois que os dados foram enviados do buffer 3, o índice é redefinido para 0 e 0 é ativado novamente.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cada um dos quatro buffers de hardware é implementado por meio de registradores disponíveis em dois locais de memória. </font><font style="vertical-align: inherit;">Há um local de memória chamado TSAD e um chamado TSD por buffer de hardware.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TSAD é o registro de início da transmissão. </font><font style="vertical-align: inherit;">Ele deve conter o endereço físico do buffer que contém os dados que o sistema operacional deseja enviar. </font><font style="vertical-align: inherit;">Os dados são transferidos entre o sistema operacional e o cartão via DMA na primeira etapa. </font><font style="vertical-align: inherit;">Depois que os dados são armazenados na memória interna do cartão, eles são transferidos para o fio a partir daí.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TSD é o status de transmissão ou registro de controle de transmissão e deve ser configurado para conter o comprimento dos dados a serem enviados nos bits 0 a 12, que é o comprimento do buffer no TSAD em bytes. </font><font style="vertical-align: inherit;">Além disso, o bit 13 (bit OWN) deve ser definido como 0. Se o bit OWN for zero (baixo), o hardware no cartão RTL 8139 começará a transmitir os dados para o cartão e do cartão para o fio. </font><font style="vertical-align: inherit;">Se a transferência de DMA entre o sistema de operação e a placa foi bem-sucedida, o bit OWN é definido como 1 (alto) pelo hardware. </font><font style="vertical-align: inherit;">Quando o bit OWN estiver alto, o cartão começará a transferir os dados da memória interna do cartão pelo fio. </font><font style="vertical-align: inherit;">Penso que o nome OWN foi escolhido para informar ao usuário que o cartão agora possui os dados a serem transferidos.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para cada um dos quatro buffers, há um par de TSAD e TSD. </font><font style="vertical-align: inherit;">Os endereços são:</font></font></p>
<pre class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">// TSAD = Transmit Start Registers = 32bit = Physical Address of data to
// be sent
u8int TSAD_array[4] = {0x20, 0x24, 0x28, 0x2C};

// TSD - Transmit Status / Command Registers = 32bit
u8int TSD_array[4] = {0x10, 0x14, 0x18, 0x1C};</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// TSAD = Transmitir registros de início = 32bit = Endereço físico dos dados para</font></font></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// ser enviado</font></font></span><span class=""></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">u8int TSAD_array </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">] </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{ </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x20 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x24 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x28 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x2C </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">} </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span><span class="co1"></span></li><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// TSD - Status de transmissão / registros de comando = 32 bits</font></font></span><span class=""></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">matriz TSD u8int </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">] </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">{ </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x10 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x14 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x18 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x1C </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">} </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li></ol><pre style="display: none;">// TSAD = Transmit Start Registers = 32bit = Physical Address of data to
// be sent
u8int TSAD_array[4] = {0x20, 0x24, 0x28, 0x2C};

// TSD - Transmit Status / Command Registers = 32bit
u8int TSD_array[4] = {0x10, 0x14, 0x18, 0x1C};</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O sistema operacional deve lembrar qual é o buffer ativo no momento, porque não é possível perguntar à placa RTL 8139 sobre qual buffer está ativo no momento. </font><font style="vertical-align: inherit;">A variável tx_cur é usada para armazenar o índice do buffer ativo.</font></font></p>
<pre class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">int tx_cur = 0;</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tx_cur = </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li></ol><pre style="display: none;">int tx_cur = 0;</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O sistema operacional prepara um buffer (matriz de bytes / caracteres) de dados a serem enviados. </font><font style="vertical-align: inherit;">Neste exemplo, vamos enviar 256 bytes contendo o caractere ASCII 'A' que possui o código hexadecimal 0x41 ou o código decimal 65.</font></font></p>
<pre class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">int len = 256;
unsigned char tx_buffer[len];
for (int i = 0; i &lt; len; i++) {
    tx_buffer[i] = 'A';
}</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">len = </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">256 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"><span class="kw1"><font style="vertical-align: inherit;">char </font></span><span class="kw1"><font style="vertical-align: inherit;">não assinado </font></span><span class=""><font style="vertical-align: inherit;">tx_buffer </font></span><span class="br0"><font style="vertical-align: inherit;">[ </font></span><span class=""><font style="vertical-align: inherit;">len </font></span><span class="br0"><font style="vertical-align: inherit;">] </font></span><span class=""><font style="vertical-align: inherit;">;</font></span></font><span class=""> </span><span class="kw1"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span></li><li class=" odd"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for </font></font></span><font style="vertical-align: inherit;"><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class="kw1"><font style="vertical-align: inherit;">int </font></span><span class=""><font style="vertical-align: inherit;">i = </font></span><span class="nu0"><font style="vertical-align: inherit;">0 </font></span><span class=""><font style="vertical-align: inherit;">; i &lt;len; i ++ </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class="kw1"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">    tx_buffer </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">] </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="st0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'A' </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">}</font></font></span></li></ol><pre style="display: none;">int len = 256;
unsigned char tx_buffer[len];
for (int i = 0; i &lt; len; i++) {
    tx_buffer[i] = 'A';
}</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A variável len armazena o tamanho do buffer.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preencha TSAD e TSD do buffer ativo no momento com os dados a serem enviados.</font></font></p>
<pre class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">// Second, fill in physical address of data to TSAD
outl(tx_buffer, ioaddr + TSAD_array[tx_cur]);

// Fill the length to TSD and start the transmission by setting the OWN
// bit to 0 Start https://wiki.osdev.org/RTL8139#Transmitting_Packets
u32int status = 0;
status |= len &amp; 0x1FFF; // 0-12: Length
status |= 0 &lt;&lt; 13;      // 13: OWN bit

outl(status, ioaddr + TSD_array[tx_cur]);</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// Segundo, preencha o endereço físico dos dados para o TSAD</font></font></span><span class=""></span></li><li class=" even"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outl </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tx_buffer, ioaddr + TSAD_array </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tx_cur </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">] </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// Preencha o comprimento para TSD e inicie a transmissão definindo OWN</font></font></span><span class="co1"></span></li><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// bit a 0 Inicie https://wiki.osdev.org/RTL8139#Transmitting_Packets</font></font></span><span class=""></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">status do u32int = </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">status | = len &amp; </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0x1FFF </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; </font></font></span><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// 0-12: comprimento</font></font></span><span class=""></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">status | = </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;&lt; </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">13 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;     </font></font></span><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// 13: PRÓPRIO bit</font></font></span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outl </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">status, ioaddr + TSD_array </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tx_cur </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">] </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li></ol><pre style="display: none;">// Second, fill in physical address of data to TSAD
outl(tx_buffer, ioaddr + TSAD_array[tx_cur]);

// Fill the length to TSD and start the transmission by setting the OWN
// bit to 0 Start https://wiki.osdev.org/RTL8139#Transmitting_Packets
u32int status = 0;
status |= len &amp; 0x1FFF; // 0-12: Length
status |= 0 &lt;&lt; 13;      // 13: OWN bit

outl(status, ioaddr + TSD_array[tx_cur]);</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aguarde até que o bit OK (bit 15) esteja alto. </font><font style="vertical-align: inherit;">Isso indica que a transmissão está concluída. </font><font style="vertical-align: inherit;">O bit OWN informará quando os dados foram transferidos entre o sistema operacional e o cartão. </font><font style="vertical-align: inherit;">Depois que os dados estiverem armazenados no cartão, eles começarão a transmitir esses dados pelo fio. </font><font style="vertical-align: inherit;">Quando a transferência bancária estiver concluída, o cartão definirá o bit OK no TSD como alto, o que significa que a transferência está concluída e o próximo buffer de transferência está ativo.</font></font></p>
<pre class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">u32int transmit_ok = inl(ioaddr + TSD_array[tx_cur]);
while (transmit_ok &amp; (1 &lt;&lt; 15) == 0) {
    k_printf("Waiting for transmit_ok ...\n");
    transmit_ok = inl(ioaddr + TSD_array[tx_cur]);
}
k_printf("Waiting for transmit_ok done. transmit_ok = %d\n", transmit_ok);</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">u32int transmit_ok = </font></font></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inl </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioaddr + TSD_array </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tx_cur </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">] </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">while </font></font></span><font style="vertical-align: inherit;"><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class=""><font style="vertical-align: inherit;">transmit_ok &amp; </font></span><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class="nu0"><font style="vertical-align: inherit;">1 </font></span><span class=""><font style="vertical-align: inherit;">&lt;&lt; </font></span><span class="nu0"><font style="vertical-align: inherit;">15 </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class=""><font style="vertical-align: inherit;">== </font></span><span class="nu0"><font style="vertical-align: inherit;">0 </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" odd"><span class="">    </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k_printf </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Aguardando transmit_ok ... \ n" </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">    transmit_ok = </font></font></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inl </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioaddr + matriz TSD </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tx_cur </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">] </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">}</font></font></span><span class=""></span></li><li class=" even"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k_printf </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Aguardando transmissão_ok concluída. transmit_ok =% d \ n" </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, transmissão_ok </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li></ol><pre style="display: none;">u32int transmit_ok = inl(ioaddr + TSD_array[tx_cur]);
while (transmit_ok &amp; (1 &lt;&lt; 15) == 0) {
    k_printf("Waiting for transmit_ok ...\n");
    transmit_ok = inl(ioaddr + TSD_array[tx_cur]);
}
k_printf("Waiting for transmit_ok done. transmit_ok = %d\n", transmit_ok);</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Informe ao sistema operacional qual buffer está ativo depois que o último buffer foi usado. </font><font style="vertical-align: inherit;">Para fazer isso, aumente tx_cur e retorne a zero se o último buffer foi usado na operação de envio anterior.</font></font></p>
<pre class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">tx_cur++;
if (tx_cur &gt; 3) {
    tx_cur = 0;
}</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tx_cur ++;</font></font></span></li><li class=" even"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if </font></font></span><font style="vertical-align: inherit;"><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class=""><font style="vertical-align: inherit;">tx_cur&gt; </font></span><span class="nu0"><font style="vertical-align: inherit;">3 </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">    tx_cur = </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">}</font></font></span></li></ol><pre style="display: none;">tx_cur++;
if (tx_cur &gt; 3) {
    tx_cur = 0;
}</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora que você é capaz de enviar uma matriz de bytes arbitrários para a rede, precisa aprender a construir quadros Ethernet válidos para um protocolo como ARP, ICMP, DHPC, TCP, IP, HTTP ou qualquer outra coisa. </font><font style="vertical-align: inherit;">Esse não é o trabalho do driver RTL 8139, portanto os detalhes não são explicados neste artigo.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Construir os quadros para um protocolo específico no modelo OSI é o trabalho da chamada pilha de IP.</font></font></p>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recuperando o endereço MAC</font></font></h5>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O RTL 8139 envia e recebe dados e, portanto, faz parte de uma rede. </font><font style="vertical-align: inherit;">Como tal, precisa de um endereço para que os pacotes possam ser enviados ponto a ponto entre o remetente e o destinatário.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nos níveis mais baixos da pilha OSI para onde os quadros Ethernet são enviados, o endereço MAC é usado para essa finalidade. </font><font style="vertical-align: inherit;">Um endereço MAC é um endereço exclusivo atribuído a um RLT 8139 durante a fabricação.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao implementar o ARP, por exemplo, você precisa saber o endereço MAC da sua placa. </font><font style="vertical-align: inherit;">Esta seção explica como recuperar o endereço MAC da NIC.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No qemu, você pode especificar o endereço MAC na linha de comando. </font><font style="vertical-align: inherit;">Conhecer o endereço MAC ao testar o código é uma grande vantagem, pois assim que você recupera o endereço MAC esperado, fica comprovado que o código funciona corretamente.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O parâmetro da linha de comandos qemu </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mac</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> especifica o endereço mac.</font></font></p>
<pre class="EnlighterJSRAW" data-enlighter-language="shell" style="display: none;">/home/&lt;user&gt;/dev/qemu/build/i386-softmmu/qemu-system-i386 \
-monitor stdio \
-cdrom image.iso \
-netdev user,id=network0 \
-device rtl8139,netdev=network0,mac=52:54:00:12:34:56 \
-object filter-dump,id=network_filter_object,netdev=network0,file=dump.dat</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ home / &lt;usuário&gt; / dev / qemu / build / i386-softmmu / qemu-system-i386 \</font></font></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-monitor stdio \</font></font></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-cdrom image.iso \</font></font></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-netdev user, id = network0 \</font></font></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-dispositivo rtl8139, netdev = rede0, mac = 52: 54: 00: 12: 34: 56 \</font></font></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-objeto de filtro de objeto, id = network_filter_object, netdev = network0, arquivo = dump.dat</font></font></span></li></ol><pre style="display: none;">/home/&lt;user&gt;/dev/qemu/build/i386-softmmu/qemu-system-i386 \
-monitor stdio \
-cdrom image.iso \
-netdev user,id=network0 \
-device rtl8139,netdev=network0,mac=52:54:00:12:34:56 \
-object filter-dump,id=network_filter_object,netdev=network0,file=dump.dat</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui 52: 54: 00: 12: 34: 56 é usado como um endereço mac.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O endereço MAC é armazenado em um chip EEPROM no cartão. </font><font style="vertical-align: inherit;">Para ler a EEPROM, você precisa de uma função.</font></font></p>
<pre class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">// Delay between EEPROM clock transitions.
// No extra delay is needed with 33Mhz PCI, but 66Mhz may change this.
#define eeprom_delay() inl(ee_addr)

// The EEPROM commands include the alway-set leading bit.
#define EE_WRITE_CMD (5 &lt;&lt; 6)
#define EE_READ_CMD (6 &lt;&lt; 6)
#define EE_ERASE_CMD (7 &lt;&lt; 6)

static int read_eeprom(long ioaddr, int location) {

  unsigned retval = 0;
  long ee_addr = ioaddr + Cfg9346;
  int read_cmd = location | EE_READ_CMD;

  outb(EE_ENB &amp; ~EE_CS, ee_addr);
  outb(EE_ENB, ee_addr);

  // Shift the read command bits out.
  for (int i = 10; i &gt;= 0; i--) {

    int dataval = (read_cmd &amp; (1 &lt;&lt; i)) ? EE_DATA_WRITE : 0;

    outb(EE_ENB | dataval, ee_addr);
    eeprom_delay();

    outb(EE_ENB | dataval | EE_SHIFT_CLK, ee_addr);
    eeprom_delay();
  }

  outb(EE_ENB, ee_addr);
  eeprom_delay();

  for (int i = 16; i &gt; 0; i--) {

    outb(EE_ENB | EE_SHIFT_CLK, ee_addr);
    eeprom_delay();

    retval = (retval &lt;&lt; 1) | ((inb(ee_addr) &amp; EE_DATA_READ) ? 1 : 0);

    outb(EE_ENB, ee_addr);
    eeprom_delay();
  }

  // Terminate the EEPROM access.
  outb(~EE_CS, ee_addr);

  return retval;
}</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// Atraso entre transições de relógio da EEPROM.</font></font></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// Nenhum atraso extra é necessário com o PCI de 33Mhz, mas 66Mhz pode mudar isso.</font></font></span><span class=""></span></li><li class=" odd"><span class=""></span><span class="kw2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#define eeprom_delay () inl (ee_addr)</font></font></span><span class=""></span></li><li class=" even"><span class=""></span><span class="co1"></span></li><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// Os comandos da EEPROM incluem o bit inicial sempre definido.</font></font></span><span class=""></span></li><li class=" even"><span class=""></span><span class="kw2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#define EE_WRITE_CMD (5 &lt;&lt; 6)</font></font></span><span class=""></span></li><li class=" odd"><span class=""></span><span class="kw2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#define EE_READ_CMD (6 &lt;&lt; 6)</font></font></span><span class=""></span></li><li class=" even"><span class=""></span><span class="kw2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#define EE_ERASE_CMD (7 &lt;&lt; 6)</font></font></span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">static </font></font></span><font style="vertical-align: inherit;"><span class="kw1"><font style="vertical-align: inherit;">int </font></span><span class="de1"><font style="vertical-align: inherit;">read_eeprom </font></span><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class="kw1"><font style="vertical-align: inherit;">long </font></span><span class=""><font style="vertical-align: inherit;">ioaddr, </font></span><span class="kw1"><font style="vertical-align: inherit;">int </font></span><span class=""><font style="vertical-align: inherit;">location </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="kw1"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="de1"><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class="kw1"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="kw1"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">  </span><span class="kw1"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retval </font></font></span><font style="vertical-align: inherit;"><span class="kw1"><font style="vertical-align: inherit;">não assinado </font></span><span class=""><font style="vertical-align: inherit;">= </font></span></font><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class="">  </span><span class="kw1"><font style="vertical-align: inherit;"></font></span><font style="vertical-align: inherit;"><span class=""><font style="vertical-align: inherit;">ee_addr </font></span><span class="kw1"><font style="vertical-align: inherit;">longo </font></span></font><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= ioaddr + Cfg9346;</font></font></span></li><li class=" even"><span class="">  </span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read_cmd = localização | </font><font style="vertical-align: inherit;">EE_READ_CMD;</font></font></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">  </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outb </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EE_ENB &amp; ~ EE_CS, ee_addr </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class="">  </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outb </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EE_ENB, ee_addr </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""> </span><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> // Desloque os bits do comando read para fora.</font></font></span><span class=""></span></li><li class=" even"><span class="">  </span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para </font></font></span><font style="vertical-align: inherit;"><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class="kw1"><font style="vertical-align: inherit;">int </font></span><span class=""><font style="vertical-align: inherit;">i = </font></span><span class="nu0"><font style="vertical-align: inherit;">10 </font></span><span class=""><font style="vertical-align: inherit;">; i&gt; = </font></span><span class="nu0"><font style="vertical-align: inherit;">0 </font></span><span class=""><font style="vertical-align: inherit;">; i-- </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class="kw1"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">    </span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dataval = </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read_cmd &amp; </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;&lt; i </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? </font><font style="vertical-align: inherit;">EE_DATA_WRITE: </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">    </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outb </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EE_ENB | dataval, ee_addr </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class="">    </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eeprom_delay </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">    </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outb </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EE_ENB | dataval | EE_SHIFT_CLK, ee_addr </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class="">    </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eeprom_delay </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class="">  </span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">}</font></font></span><span class=""></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">  </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outb </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EE_ENB, ee_addr </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class="">  </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eeprom_delay </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">  </span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para </font></font></span><font style="vertical-align: inherit;"><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class="kw1"><font style="vertical-align: inherit;">int </font></span><span class=""><font style="vertical-align: inherit;">i = </font></span><span class="nu0"><font style="vertical-align: inherit;">16 </font></span><span class=""><font style="vertical-align: inherit;">; i&gt; </font></span><span class="nu0"><font style="vertical-align: inherit;">0 </font></span><span class=""><font style="vertical-align: inherit;">; i-- </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class="kw1"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">    </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outb </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EE_ENB | EE_SHIFT_CLK, ee_addr </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class="">    </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eeprom_delay </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">    retval = </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retval &lt;&lt; </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">| </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inb </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ee_addr </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&amp; EE_DATA_READ </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">? </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class="">    </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outb </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EE_ENB, ee_addr </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class="">    </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">eeprom_delay </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class="">  </span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">}</font></font></span><span class=""></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""> </span><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> // Finalize o acesso à EEPROM.</font></font></span><span class=""></span></li><li class=" even"><span class="">  </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">outb </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">~ EE_CS, ee_addr </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class="">  </span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retorno </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retval;</font></font></span></li><li class=" odd"><span class=""></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">}</font></font></span></li></ol><pre style="display: none;">// Delay between EEPROM clock transitions.
// No extra delay is needed with 33Mhz PCI, but 66Mhz may change this.
#define eeprom_delay() inl(ee_addr)

// The EEPROM commands include the alway-set leading bit.
#define EE_WRITE_CMD (5 &lt;&lt; 6)
#define EE_READ_CMD (6 &lt;&lt; 6)
#define EE_ERASE_CMD (7 &lt;&lt; 6)

static int read_eeprom(long ioaddr, int location) {

  unsigned retval = 0;
  long ee_addr = ioaddr + Cfg9346;
  int read_cmd = location | EE_READ_CMD;

  outb(EE_ENB &amp; ~EE_CS, ee_addr);
  outb(EE_ENB, ee_addr);

  // Shift the read command bits out.
  for (int i = 10; i &gt;= 0; i--) {

    int dataval = (read_cmd &amp; (1 &lt;&lt; i)) ? EE_DATA_WRITE : 0;

    outb(EE_ENB | dataval, ee_addr);
    eeprom_delay();

    outb(EE_ENB | dataval | EE_SHIFT_CLK, ee_addr);
    eeprom_delay();
  }

  outb(EE_ENB, ee_addr);
  eeprom_delay();

  for (int i = 16; i &gt; 0; i--) {

    outb(EE_ENB | EE_SHIFT_CLK, ee_addr);
    eeprom_delay();

    retval = (retval &lt;&lt; 1) | ((inb(ee_addr) &amp; EE_DATA_READ) ? 1 : 0);

    outb(EE_ENB, ee_addr);
    eeprom_delay();
  }

  // Terminate the EEPROM access.
  outb(~EE_CS, ee_addr);

  return retval;
}</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando esta função, o MAC pode ser lido e armazenado em uma matriz. </font><font style="vertical-align: inherit;">A matriz é então enviada para mostrar que o endereço MAC correto é lido.</font></font></p>
<pre class="EnlighterJSRAW" data-enlighter-language="c" style="display: none;">// prepare mac address read
int mac_address_index = 0;
u32int mac_address[6];
for (int i = 0; i &lt; 6; i++) {
  mac_address[i] = 0;
}

// Read EEPROM
//
// Read the MAC Addresses from the NIC's EEPROM memory chip
// k_printf("read_eeprom() ...\n");

int readEEPROMResult = read_eeprom(ioaddr, 0) != 0xffff;
if (readEEPROMResult) {

  // loop three times to read three int (= 32 bit)
  for (int i = 0; i &lt; 3; i++) {

    u16int data = read_eeprom(ioaddr, i + 7);

    mac_address[mac_address_index] = data &amp; 0xFF;
    mac_address[mac_address_index + 1] = data &gt;&gt; 8;

    mac_address_index += 2;
  }

} else {

  // loop six times
  for (int i = 0; i &lt; 6; i++) {

    u16int data = inb(ioaddr + i);

    mac_address_index += 1;
  }
}

// DEBUG: print MAC Address
k_printf("MAC: ");
for (int i = 0; i &lt; 6; i++) {
  k_printf("%x:", mac_address[i]);
}
k_printf("\n");</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// preparar endereço mac lido</font></font></span><span class=""></span></li><li class=" even"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mac_address_index = </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">endereço_ mac do u32int </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">] </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for </font></font></span><font style="vertical-align: inherit;"><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class="kw1"><font style="vertical-align: inherit;">int </font></span><span class=""><font style="vertical-align: inherit;">i = </font></span><span class="nu0"><font style="vertical-align: inherit;">0 </font></span><span class=""><font style="vertical-align: inherit;">; i &lt; </font></span><span class="nu0"><font style="vertical-align: inherit;">6 </font></span><span class=""><font style="vertical-align: inherit;">; i ++ </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class="kw1"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">  endereço_ mac </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">] </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">}</font></font></span><span class=""></span></li><li class=" odd"><span class=""></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// Leia EEPROM</font></font></span><span class="co1"></span></li><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">//</font></font></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// Leia os endereços MAC do chip de memória EEPROM da NIC</font></font></span><span class="co1"></span></li><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// k_printf ("read_eeprom () ... \ n");</font></font></span><span class=""></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">readEEPROMResult = </font></font></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read_eeprom </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioaddr, </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">! = </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0xffff </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if </font></font></span><font style="vertical-align: inherit;"><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class=""><font style="vertical-align: inherit;">readEEPROMResult </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""> </span><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> // executa um loop três vezes para ler três int (= 32 bits)</font></font></span><span class=""></span></li><li class=" odd"><span class="">  </span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for </font></font></span><font style="vertical-align: inherit;"><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class="kw1"><font style="vertical-align: inherit;">int </font></span><span class=""><font style="vertical-align: inherit;">i = </font></span><span class="nu0"><font style="vertical-align: inherit;">0 </font></span><span class=""><font style="vertical-align: inherit;">; i &lt; </font></span><span class="nu0"><font style="vertical-align: inherit;">3 </font></span><span class=""><font style="vertical-align: inherit;">; i ++ </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class="kw1"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">    u16int data = </font></font></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">read_eeprom </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioaddr, i + </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">    mac_address </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mac_address_index </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">] </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= dados &amp; </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0xFF </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">    mac_address </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mac_address_index + </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">] </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= dados &gt;&gt; </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">    mac_address_index + = </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class="">  </span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">}</font></font></span><span class=""></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">} </font></font></span><font style="vertical-align: inherit;"><span class="kw1"><font style="vertical-align: inherit;">mais </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="kw1"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""> </span><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> // loop seis vezes</font></font></span><span class=""></span></li><li class=" even"><span class="">  </span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for </font></font></span><font style="vertical-align: inherit;"><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class="kw1"><font style="vertical-align: inherit;">int </font></span><span class=""><font style="vertical-align: inherit;">i = </font></span><span class="nu0"><font style="vertical-align: inherit;">0 </font></span><span class=""><font style="vertical-align: inherit;">; i &lt; </font></span><span class="nu0"><font style="vertical-align: inherit;">6 </font></span><span class=""><font style="vertical-align: inherit;">; i ++ </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class="kw1"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">    dados u16int = </font></font></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inb </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ioaddr + i </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">    mac_address_index + = </font></font></span><span class="nu0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" odd"><span class="">  </span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">}</font></font></span><span class=""></span></li><li class=" even"><span class=""></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">}</font></font></span><span class=""></span></li><li class=" odd"><span class=""></span><span class="co1"></span></li><li class=" even"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// DEBUG: imprimir endereço MAC</font></font></span><span class=""></span></li><li class=" odd"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k_printf </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"MAC:" </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for </font></font></span><font style="vertical-align: inherit;"><span class="br0"><font style="vertical-align: inherit;">( </font></span><span class="kw1"><font style="vertical-align: inherit;">int </font></span><span class=""><font style="vertical-align: inherit;">i = </font></span><span class="nu0"><font style="vertical-align: inherit;">0 </font></span><span class=""><font style="vertical-align: inherit;">; i &lt; </font></span><span class="nu0"><font style="vertical-align: inherit;">6 </font></span><span class=""><font style="vertical-align: inherit;">; i ++ </font></span><span class="br0"><font style="vertical-align: inherit;">) </font></span><span class="br0"><font style="vertical-align: inherit;">{</font></span></font><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class="kw1"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="nu0"><font style="vertical-align: inherit;"></font></span><span class=""><font style="vertical-align: inherit;"></font></span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""> </span><span class="br0"><font style="vertical-align: inherit;"></font></span><span class=""></span></li><li class=" odd"><span class="">  </span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k_printf </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"% x:" </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, endereço_ mac </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">] </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li><li class=" even"><span class=""></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">}</font></font></span><span class=""></span></li><li class=" odd"><span class=""></span><span class="de1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">k_printf </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="st1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"\ n" </font></font></span><span class="br0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">;</font></font></span></li></ol><pre style="display: none;">// prepare mac address read
int mac_address_index = 0;
u32int mac_address[6];
for (int i = 0; i &lt; 6; i++) {
  mac_address[i] = 0;
}

// Read EEPROM
//
// Read the MAC Addresses from the NIC's EEPROM memory chip
// k_printf("read_eeprom() ...\n");

int readEEPROMResult = read_eeprom(ioaddr, 0) != 0xffff;
if (readEEPROMResult) {

  // loop three times to read three int (= 32 bit)
  for (int i = 0; i &lt; 3; i++) {

    u16int data = read_eeprom(ioaddr, i + 7);

    mac_address[mac_address_index] = data &amp; 0xFF;
    mac_address[mac_address_index + 1] = data &gt;&gt; 8;

    mac_address_index += 2;
  }

} else {

  // loop six times
  for (int i = 0; i &lt; 6; i++) {

    u16int data = inb(ioaddr + i);

    mac_address_index += 1;
  }
}

// DEBUG: print MAC Address
k_printf("MAC: ");
for (int i = 0; i &lt; 6; i++) {
  k_printf("%x:", mac_address[i]);
}
k_printf("\n");</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>&nbsp;</p>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depuração</font></font></h5>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta seção apresentará duas maneiras de depurar o processo de envio de dados usando o RTL 8139.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O primeiro método é dizer ao qemu para despejar todos os pacotes de entrada e saída em um arquivo. </font><font style="vertical-align: inherit;">O arquivo está no formato pcap, o que permite abrir o arquivo no wireshark. </font><font style="vertical-align: inherit;">O wireshark é uma ferramenta de rede que pode exibir todos os campos em pacotes Ethernet e conhece uma grande variedade de protocolos para exibição detalhada de todos os campos em pacotes.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se o driver RTL enviar dados, você poderá ver quais dados são enviados carregando o arquivo de despejo e olhando os pacotes de envio usando o wireshark.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O segundo método é compilar o qemu e habilitar a saída de depuração na camada de emulação da placa RTL 8139. </font><font style="vertical-align: inherit;">Infelizmente, não há parâmetro de linha de comando para ativar a saída de depuração RTL 8139. </font><font style="vertical-align: inherit;">Você só pode ativar a saída de depuração alterando o código do qemu e compilando o qemu. </font><font style="vertical-align: inherit;">Parece difícil, mas na verdade é bem fácil. </font><font style="vertical-align: inherit;">Se eu consegui, você também poderá fazer isso facilmente. </font><font style="vertical-align: inherit;">Este método foi testado apenas em um Linux linux. </font><font style="vertical-align: inherit;">As etapas para compilar no Windows ou Mac são desconhecidas para mim. </font><font style="vertical-align: inherit;">Você pode seguir o método 2 no Ubuntu linux facilmente.</font></font></p>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despejando tráfego de rede com qemu</font></font></h5>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O qemu contém internamente os chamados objetos para diversos fins. </font><font style="vertical-align: inherit;">Um desses objetos é o objeto de filtro-despejo. </font><font style="vertical-align: inherit;">Você pode aplicar o objeto filter-dump a uma das placas de interface de rede para despejar todos os pacotes em um arquivo.</font></font></p>
<pre class="EnlighterJSRAW" data-enlighter-language="shell" style="display: none;">/home/&lt;user&gt;/dev/qemu/build/i386-softmmu/qemu-system-i386 \
-monitor stdio \
-cdrom image.iso \
-netdev user,id=network0 \
-device rtl8139,netdev=network0,mac=52:54:00:12:34:56 \
-object filter-dump,id=network_filter_object,netdev=network0,file=dump.dat</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ home / &lt;usuário&gt; / dev / qemu / build / i386-softmmu / qemu-system-i386 \</font></font></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-monitor stdio \</font></font></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-cdrom image.iso \</font></font></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-netdev user, id = network0 \</font></font></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-dispositivo rtl8139, netdev = rede0, mac = 52: 54: 00: 12: 34: 56 \</font></font></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-objeto de filtro de objeto, id = network_filter_object, netdev = network0, arquivo = dump.dat</font></font></span></li></ol><pre style="display: none;">/home/&lt;user&gt;/dev/qemu/build/i386-softmmu/qemu-system-i386 \
-monitor stdio \
-cdrom image.iso \
-netdev user,id=network0 \
-device rtl8139,netdev=network0,mac=52:54:00:12:34:56 \
-object filter-dump,id=network_filter_object,netdev=network0,file=dump.dat</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O objeto filter-dump é apontado para o netdev. </font><font style="vertical-align: inherit;">Ele capturará o tráfego nesse netdev. </font><font style="vertical-align: inherit;">O netdev é o RTL 8139 NIC. </font><font style="vertical-align: inherit;">O arquivo de saída é chamado dump.dat e é gravado na pasta onde você inicia o qemu.</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abra dump.dat no qemu. </font><font style="vertical-align: inherit;">Você deve ver o pacote que você enviou! </font><font style="vertical-align: inherit;">Se o RTL 8139 enviar apenas zeros, verifique se você está especificando endereços virtuais e verifique o código que permite a sua masterização.</font></font></p>
<h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compile o qemu e ative a saída de depuração RTL</font></font></h5>
<pre class="EnlighterJSRAW" data-enlighter-language="shell" style="display: none;">https://forum.osdev.org/viewtopic.php?f=1&amp;t=28285

In qemu/hw/net/rtl8139.c

#define DEBUG_RTL8139 1
replace by
define DEBUG_RTL8139 1

Build Qemu
https://en.wikibooks.org/wiki/QEMU/Installing_QEMU

0. sudo apt-get install libglib2.0-dev libpango1.0-dev libatk1.0-dev libsdl2-dev
1. git clone git://git.qemu-project.org/qemu.git
2. cd qemu
3. git submodule init
4. git submodule update --recursive
5. git submodule status --recursive
6. git checkout stable-4.1
7. mkdir build
8. cd build
9. ../configure --disable-kvm --prefix=PFX --target-list="i386-softmmu x86_64-softmmu" --enable-sdl
10. make

In step 6, replace the version number with the most current qemu release.
In step 9, the command specifies targets and only lists i386. That way only x86 32 bit qemu is built.
If you call ../configure without additional parameters, qemu will be build for all possible targets which will take forever.

The qemu executable will be placed inside build folder. For example in /home/&lt;user&gt;/dev/qemu/build/i386-softmmu/qemu-system-i386&nbsp;

</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://forum.osdev.org/viewtopic.php?f=1&amp;t=28285</font></font></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em qemu / hw / net / rtl8139.c</font></font></span><span class="co1"></span></li><li class=" even"><span class="co1"></span></li><li class=" odd"><span class="co1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#define DEBUG_RTL8139 1</font></font></span><span class=""></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">substituir por</font></font></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">definir DEBUG_RTL8139 1</font></font></span></li><li class=" even"><span class=""></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Build Qemu</font></font></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://en.wikibooks.org/wiki/QEMU/Installing_QEMU</font></font></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0. sudo apt-get install libglib2.0-dev libpango1.0-dev libatk1.0-dev libsdl2-dev</font></font></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. git clone git: //git.qemu-project.org/qemu.git</font></font></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2. cd qemu</font></font></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3. git submodule init</font></font></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4. atualização do sub-módulo git --recursive</font></font></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5. status do sub-módulo git --recursive</font></font></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. verificação geral do git stable-4.1</font></font></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7. compilação do mkdir</font></font></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8. construção do cd</font></font></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">9. ../configure --disable-kvm --prefix = PFX --target-list = </font></font></span><span class="st0"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"i386-softmmu x86_64-softmmu" </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">--enable-sdl</font></font></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">10. faça</font></font></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na etapa 6, substitua o número da versão pela versão mais recente do qemu.</font></font></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na etapa 9, o comando especifica destinos e lista apenas i386. </font><font style="vertical-align: inherit;">Dessa forma, apenas o qemu x86 de 32 bits é construído.</font></font></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se você chamar ../configure sem parâmetros adicionais, o qemu será criado </font></font></span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">todos os destinos possíveis que levarão uma eternidade.</font></font></span></li><li class=" odd"><span class=""></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O executável qemu será colocado dentro da pasta build. </font><font style="vertical-align: inherit;">Por exemplo, </font></font></span><span class="kw1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em </font></font></span><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ home / &lt;usuário&gt; / dev / qemu / build / i386-softmmu / qemu-system-i386</font></font></span></li></ol><pre style="display: none;">https://forum.osdev.org/viewtopic.php?f=1&amp;t=28285

In qemu/hw/net/rtl8139.c

#define DEBUG_RTL8139 1
replace by
define DEBUG_RTL8139 1

Build Qemu
https://en.wikibooks.org/wiki/QEMU/Installing_QEMU

0. sudo apt-get install libglib2.0-dev libpango1.0-dev libatk1.0-dev libsdl2-dev
1. git clone git://git.qemu-project.org/qemu.git
2. cd qemu
3. git submodule init
4. git submodule update --recursive
5. git submodule status --recursive
6. git checkout stable-4.1
7. mkdir build
8. cd build
9. ../configure --disable-kvm --prefix=PFX --target-list="i386-softmmu x86_64-softmmu" --enable-sdl
10. make

In step 6, replace the version number with the most current qemu release.
In step 9, the command specifies targets and only lists i386. That way only x86 32 bit qemu is built.
If you call ../configure without additional parameters, qemu will be build for all possible targets which will take forever.

The qemu executable will be placed inside build folder. For example in /home/&lt;user&gt;/dev/qemu/build/i386-softmmu/qemu-system-i386 </pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora, o qemu produzirá instruções de depuração na linha de comando. </font><font style="vertical-align: inherit;">Você deve ver linhas como estas:</font></font></p>
<pre class="EnlighterJSRAW" data-enlighter-language="shell" style="display: none;">RTL8139: +++ transmitting from descriptor 0
RTL8139: +++ transmit reading 42 bytes from host memory at 0x0010504a
RTL8139: +++ transmitted 42 bytes from descriptor 0</pre><div class="EnlighterJSWrapper enlighterEnlighterJSWrapper"><ol class="hoverEnabled enlighterEnlighterJS EnlighterJS"><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTL8139: +++ transmitindo do descritor 0</font></font></span></li><li class=" even"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTL8139: +++ transmitir leitura de 42 bytes da memória host em 0x0010504a</font></font></span></li><li class=" odd"><span class=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RTL8139: +++ transmitiu 42 bytes do descritor 0</font></font></span></li></ol><pre style="display: none;">RTL8139: +++ transmitting from descriptor 0
RTL8139: +++ transmit reading 42 bytes from host memory at 0x0010504a
RTL8139: +++ transmitted 42 bytes from descriptor 0</pre><div class="EnlighterJSToolbar"><a class="EnlighterJSInfoButton" title="EnlighterJS Syntax Highlighter"></a><a class="EnlighterJSRawButton" title="Toggle RAW Code"></a><a class="EnlighterJSWindowButton" title="Open Code in new Window"></a><span class="clear"></span></div></div>
<p>&nbsp;</p>
<p>&nbsp;</p>
	</div><!-- .entry-content -->
	
	<footer class="entry-meta">
		
			</footer><!-- .entry-meta -->
</article><!-- #post -->
						<nav class="navigation post-navigation" role="navigation">
		<h1 class="screen-reader-text"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pós-navegação</font></font></h1>
		<div class="nav-links">

			<a href="https://www.wfbsoftware.de/2019/07/18/c-unit-testing-with-cmocka/" rel="prev"><span class="meta-nav"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">←</font></font></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Teste de unidade C com cmocka </font></font></a>			<a href="https://www.wfbsoftware.de/2019/07/22/tcp-ip-stack/" rel="next"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ARP de pilha TCP / IP </font></font><span class="meta-nav"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">→</font></font></span></a>
		</div><!-- .nav-links -->
	</nav><!-- .navigation -->
						
			
		</div><!-- #content -->
	</div><!-- #primary -->


		</div><!-- #main -->
		<footer id="colophon" class="site-footer" role="contentinfo">
				<div id="secondary" class="sidebar-container" role="complementary">
		<div class="widget-area masonry" style="position: relative; height: 1027px;">
			<aside id="search-2" class="widget widget_search masonry-brick" style="position: absolute; left: 0px; top: 0px;"><form role="search" method="get" class="search-form" action="https://www.wfbsoftware.de/">
				<label>
					<span class="screen-reader-text"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Procurar por:</font></font></span>
					<input type="search" class="search-field" placeholder="Pesquisar…" value="" name="s">
				</label>
				<input type="submit" class="search-submit" value="Search">
			</form></aside>		<aside id="recent-posts-2" class="widget widget_recent_entries masonry-brick" style="position: absolute; left: 265px; top: 0px;">		<h3 class="widget-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Postagens recentes</font></font></h3>		<ul>
											<li>
					<a href="https://www.wfbsoftware.de/2020/02/29/assembly-programming-and-debugging-in-eclipse-on-linux/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programação de montagem e depuração no Eclipse no Linux</font></font></a>
									</li>
											<li>
					<a href="https://www.wfbsoftware.de/2020/02/23/powering-the-sam7-la2-board/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ligando a placa SAM7-LA2</font></font></a>
									</li>
											<li>
					<a href="https://www.wfbsoftware.de/2020/02/22/stm32f103c8t6-with-eclipse-openstm32-under-mac-osx/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32F103C8T6 com Eclipse (OpenSTM32) no Mac OSX</font></font></a>
									</li>
											<li>
					<a href="https://www.wfbsoftware.de/2020/01/31/stm32f103c8t6-with-arduino-ide/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32F103C8T6 com Arduino IDE</font></font></a>
									</li>
											<li>
					<a href="https://www.wfbsoftware.de/2020/01/22/stm32cubemx-on-macos/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32CubeMX no MacOS</font></font></a>
									</li>
					</ul>
		</aside><aside id="archives-2" class="widget widget_archive masonry-brick" style="position: absolute; left: 530px; top: 0px;"><h3 class="widget-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arquivos</font></font></h3>		<ul>
			<li><a href="https://www.wfbsoftware.de/2020/02/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fevereiro 2020</font></font></a></li>
	<li><a href="https://www.wfbsoftware.de/2020/01/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Janeiro 2020</font></font></a></li>
	<li><a href="https://www.wfbsoftware.de/2019/12/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dezembro 2019</font></font></a></li>
	<li><a href="https://www.wfbsoftware.de/2019/11/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Novembro 2019</font></font></a></li>
	<li><a href="https://www.wfbsoftware.de/2019/10/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outubro 2019</font></font></a></li>
	<li><a href="https://www.wfbsoftware.de/2019/08/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agosto 2019</font></font></a></li>
	<li><a href="https://www.wfbsoftware.de/2019/07/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Julho 2019</font></font></a></li>
	<li><a href="https://www.wfbsoftware.de/2019/06/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Junho 2019</font></font></a></li>
	<li><a href="https://www.wfbsoftware.de/2019/01/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Janeiro 2019</font></font></a></li>
	<li><a href="https://www.wfbsoftware.de/2018/12/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dezembro 2018</font></font></a></li>
		</ul>
		</aside><aside id="categories-2" class="widget widget_categories masonry-brick" style="position: absolute; left: 795px; top: 0px;"><h3 class="widget-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Categorias</font></font></h3>		<ul>
	<li class="cat-item cat-item-24"><a href="https://www.wfbsoftware.de/category/net-core/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.NET Core</font></font></a>
</li>
	<li class="cat-item cat-item-17"><a href="https://www.wfbsoftware.de/category/javascript/angular/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Angular</font></font></a>
</li>
	<li class="cat-item cat-item-25"><a href="https://www.wfbsoftware.de/category/net-core/asp-net-core/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ASP.NET Core</font></font></a>
</li>
	<li class="cat-item cat-item-18"><a href="https://www.wfbsoftware.de/category/assembler/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Montador</font></font></a>
</li>
	<li class="cat-item cat-item-20"><a href="https://www.wfbsoftware.de/category/c-2/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></a>
</li>
	<li class="cat-item cat-item-26"><a href="https://www.wfbsoftware.de/category/net-core/c-net-core/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C #</font></font></a>
</li>
	<li class="cat-item cat-item-8"><a href="https://www.wfbsoftware.de/category/c/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C ++</font></font></a>
</li>
	<li class="cat-item cat-item-12"><a href="https://www.wfbsoftware.de/category/python/django/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Django</font></font></a>
</li>
	<li class="cat-item cat-item-22"><a href="https://www.wfbsoftware.de/category/c-2/driver-development/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desenvolvimento de drivers</font></font></a>
</li>
	<li class="cat-item cat-item-27"><a href="https://www.wfbsoftware.de/category/embedded/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">embutido</font></font></a>
</li>
	<li class="cat-item cat-item-7"><a href="https://www.wfbsoftware.de/category/javascript/node/express/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Expressar</font></font></a>
</li>
	<li class="cat-item cat-item-15"><a href="https://www.wfbsoftware.de/category/c/flexbison/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FlexBison</font></font></a>
</li>
	<li class="cat-item cat-item-2"><a href="https://www.wfbsoftware.de/category/javascript/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Javascript</font></font></a>
</li>
	<li class="cat-item cat-item-10"><a href="https://www.wfbsoftware.de/category/javascript/jest/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jest</font></font></a>
</li>
	<li class="cat-item cat-item-16"><a href="https://www.wfbsoftware.de/category/microcontrollers/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Microcontroladores</font></font></a>
</li>
	<li class="cat-item cat-item-29"><a href="https://www.wfbsoftware.de/category/modeltrains/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ModelTrains</font></font></a>
</li>
	<li class="cat-item cat-item-9"><a href="https://www.wfbsoftware.de/category/mongodb/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MongoDB</font></font></a>
</li>
	<li class="cat-item cat-item-23"><a href="https://www.wfbsoftware.de/category/networkprogramming/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programação em rede</font></font></a>
</li>
	<li class="cat-item cat-item-6"><a href="https://www.wfbsoftware.de/category/javascript/node/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nó</font></font></a>
</li>
	<li class="cat-item cat-item-31"><a href="https://www.wfbsoftware.de/category/opencv/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenCV</font></font></a>
</li>
	<li class="cat-item cat-item-13"><a href="https://www.wfbsoftware.de/category/opengl/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OpenGL</font></font></a>
</li>
	<li class="cat-item cat-item-19"><a href="https://www.wfbsoftware.de/category/operatingsystems/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sistemas operacionais</font></font></a>
</li>
	<li class="cat-item cat-item-14"><a href="https://www.wfbsoftware.de/category/c/poco/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Poco</font></font></a>
</li>
	<li class="cat-item cat-item-11"><a href="https://www.wfbsoftware.de/category/python/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pitão</font></font></a>
</li>
	<li class="cat-item cat-item-3"><a href="https://www.wfbsoftware.de/category/javascript/react/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reagir</font></font></a>
</li>
	<li class="cat-item cat-item-4"><a href="https://www.wfbsoftware.de/category/javascript/redux/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Restaurado</font></font></a>
</li>
	<li class="cat-item cat-item-30"><a href="https://www.wfbsoftware.de/category/javascript/node/sequelize/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sequelizar</font></font></a>
</li>
	<li class="cat-item cat-item-28"><a href="https://www.wfbsoftware.de/category/embedded/stm32/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32</font></font></a>
</li>
	<li class="cat-item cat-item-1"><a href="https://www.wfbsoftware.de/category/uncategorized/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem categoria</font></font></a>
</li>
	<li class="cat-item cat-item-21"><a href="https://www.wfbsoftware.de/category/c-2/unit-testing/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teste de Unidade</font></font></a>
</li>
		</ul>
</aside><aside id="meta-2" class="widget widget_meta masonry-brick" style="position: absolute; left: 0px; top: 94px;"><h3 class="widget-title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Meta</font></font></h3>			<ul>
						<li><a href="https://www.wfbsoftware.de/wp-login.php"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conecte-se</font></font></a></li>
			<li><a href="https://www.wfbsoftware.de/feed/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entradas </font></font><abbr title="Organização realmente simples"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RSS</font></font></abbr></a></li>
			<li><a href="https://www.wfbsoftware.de/comments/feed/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comentários </font></font><abbr title="Organização realmente simples"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RSS</font></font></abbr></a></li>
			<li><a href="https://wordpress.org/" title="Desenvolvido com WordPress, plataforma de publicação pessoal semântica de ponta."><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WordPress.org</font></font></a></li>			</ul>
			</aside>		</div><!-- .widget-area -->
	</div><!-- #secondary -->

			<div class="site-info">
												<a href="https://wordpress.org/" class="imprint"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
					Orgulhosamente desenvolvido com WordPress				</font></font></a>
			</div><!-- .site-info -->
		</footer><!-- #colophon -->
	</div><!-- #page -->

	<script type="text/javascript" src="./RTL8139_PtBr_files/imagesloaded.min.js.download"></script>
<script type="text/javascript" src="./RTL8139_PtBr_files/masonry.min.js.download"></script>
<script type="text/javascript" src="./RTL8139_PtBr_files/jquery.masonry.min.js.download"></script>
<script type="text/javascript" src="./RTL8139_PtBr_files/functions.js.download"></script>
<script type="text/javascript" src="./RTL8139_PtBr_files/mootools-core-yc.js.download"></script>
<script type="text/javascript" src="./RTL8139_PtBr_files/EnlighterJS.min.js.download"></script>
<script type="text/javascript" src="./RTL8139_PtBr_files/wp-embed.min.js.download"></script>
<script type="text/javascript">/* <![CDATA[ */EnlighterJS_Config = {"selector":{"block":"pre.EnlighterJSRAW","inline":"code.EnlighterJSRAW"},"language":"generic","theme":"enlighter","indent":2,"hover":"hoverEnabled","showLinenumbers":true,"rawButton":true,"infoButton":true,"windowButton":true,"rawcodeDoubleclick":false,"grouping":true,"cryptex":{"enabled":false,"email":"mail@example.tld"}};!function(){var a=function(a){var b="Enlighter Error: ";console.error?console.error(b+a):console.log&&console.log(b+a)};return window.addEvent?"undefined"==typeof EnlighterJS?void a("Javascript Resources not loaded yet!"):"undefined"==typeof EnlighterJS_Config?void a("Configuration not loaded yet!"):void window.addEvent("domready",function(){EnlighterJS.Util.Init(EnlighterJS_Config.selector.block,EnlighterJS_Config.selector.inline,EnlighterJS_Config)}):void a("MooTools Framework not loaded yet!")}();;/* ]]> */</script><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="./RTL8139_PtBr_files/translate_24dp.png" width="20" height="20" alt="Google Tradutor"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">Texto original</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">Sugerir uma tradução melhor</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div>

<div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div></body></html>