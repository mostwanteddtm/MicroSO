@ECHO OFF
SET /P QUESTION=SELECT TEMPLATE: 1 ) WINDOWS PE FILE FORMAT .EXE - 2 ) MS-DOS - FILE EXTENSION .COM [1] ?

IF "%QUESTION%"=="1" (
    SET x86=__EXE__
) ELSE (
    SET x86=__COM__
)

SET LIB=..\LIB

PUSHD %cd%
CD %LIB%
CALL KERNEL16.BAT

SET PATH=C:\MSVC\BIN;C:\PROGRAM FILES\QEMU;C:\PROGRAM FILES\WINIMAGE;C:\MASM615\BIN;
SET BIN=..\BIN\
SET INCLUDE=..\INCLUDE\
SET STARTUP=..\STARTUP\
SET CMODEL=
SET LMODEL=
SET IMAGE="C:\PROGRAM FILES\QEMU\images\msdos\msdos.img"
SET FILE=%BIN%MAIN.EXE

IF "%x86%"=="" (
    SET x86=__EXE__
    SET FILE=%BIN%MAIN.EXE
)

IF "%x86%"=="__COM__" (
    SET CMODEL=/AT
    SET LMODEL=/TINY
    SET FILE=%BIN%MAIN.COM
)

IF EXIST "CRT0.ASM" ( DEL CRT0.ASM )
COPY %STARTUP%CRT0.ASM

IF EXIST "STDIO.INC" ( DEL STDIO.INC )
COPY %INCLUDE%STDIO.INC

IF EXIST "KERNEL16.LIB" ( DEL KERNEL16.LIB )
COPY %LIB%\KERNEL16.LIB

ML /c %CMODEL% /D %x86%=1 CRT0.ASM
CL /I%INCLUDE% /G2 /Gs /c /Zl MAIN.C /link KERNEL16/NOD
LINK /NOD %MODEL% CRT0 MAIN KERNEL16.LIB,%FILE%,,,,

DEL *.OBJ *.INC *.LIB CRT0.ASM

PUSHD %cd%
WINIMAGE %IMAGE% /I /Q /H %FILE%
CD "C:\PROGRAM FILES\QEMU\IMAGES\MSDOS\"
MSDOS