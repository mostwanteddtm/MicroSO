@ECHO OFF
SET PE=__COM__
SET LIB=..\LIB

PUSHD %cd%
CD %LIB%
CALL KERNEL16.BAT

SET PATH=C:\MSVC\BIN;C:\PROGRAM FILES\QEMU;C:\PROGRAM FILES\WINIMAGE;C:\MASM615\BIN;
SET BIN=..\BIN\
SET INCLUDE=..\INCLUDE\
SET STARTUP=..\STARTUP\
SET CMODEL=
SET LMODEL=
SET IMAGE="C:\PROGRAM FILES\QEMU\images\msdos\msdos.img"
SET FILE=%BIN%MAIN.EXE

IF "%PE%"=="" (
    SET PE=__EXE__
    SET FILE=%BIN%MAIN.EXE
)

IF "%PE%"=="__COM__" (
    SET CMODEL=/AT
    SET LMODEL=/TINY
    SET FILE=%BIN%MAIN.COM
)

IF EXIST "CRT0.INC" ( DEL CRT0.INC )
COPY %STARTUP%CRT0.INC

IF EXIST "STDIO.INC" ( DEL STDIO.INC )
COPY %INCLUDE%STDIO.INC

IF EXIST "KERNEL16.LIB" ( DEL KERNEL16.LIB )
COPY %LIB%\KERNEL16.LIB

ML /c %CMODEL% /D %PE%=1 TINY.ASM
LINK /NOD %MODEL% TINY.OBJ KERNEL16.LIB,%FILE%,,,,

DEL *.OBJ *.INC *.LIB

PUSHD %cd%
WINIMAGE %IMAGE% /I /Q /H %FILE%
CD "C:\PROGRAM FILES\QEMU\IMAGES\MSDOS\"
MSDOS