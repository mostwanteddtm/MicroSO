CODESEG32 SEGMENT USE32
	ASSUME CS:SEGS32,DS:SEGS32
	
	COPY_KERNEL32_TO_1MB PROC

		MOV		AX, SELDATADESC32
		MOV		DS, AX

		XOR		EAX, EAX
		XOR		ECX, ECX
		MOV		ESI, OFFSET TOTALSECTORS

		MOV		CL, BYTE PTR [ESI]					; TOTAL SECTORS
		MOV		EAX, 80H							; 512d BYTES PER SECTOR | 200h BYTES PER SECTOR | 80h DWORD (4 BYTES) PER SECTOR (80h * 4) = 200h OR 512d 
		MUL		ECX
		XCHG	EAX, ECX

		MOV 	AX, SELKERNELDESC16
		MOV 	DS, AX
		MOV 	AX, SELKERNELDATA32
		MOV 	ES, AX

		XOR		ESI, ESI
		XOR		EDI, EDI
		REP 	MOVSD								; MOV DWORD
		

		MOV		AX, SELDATADESC32
		MOV		DS, AX
		MOV		ESI, OFFSET IMAGESIG
		MOV		EDI, 3Ch							; OFFSET CONTAIN INITIAL ADDRESS OF OPTIONAL_FILE_HEADER
		MOV		EBX, ES:[EDI]						; OFFSET CONATIN SIGNATURE 'PE' = 5045h
		MOV		EDI, EBX
		
		CMPSW
		
		JNE 	ERROREXECUTE
        
		ADD		EBX, 28h							; START ADDRESS OF OPTIONAL_FILE_HEADER + 28h = [3Ch + 28h = 64h] ADDRESS OF ENTRYPOINT		
		MOV		EDI, EBX
		MOV		EBX, ES:[EDI]
		MOV		DWORD PTR ENTRYPOINT32, EBX

		RET
		
	ERROREXECUTE:
		MOV		AX, SELVIDEODESC32
		MOV		ES, AX
		XOR		EDI, EDI
		MOV		AL, 30h
		STOSB
		HLT

	COPY_KERNEL32_TO_1MB ENDP
	
CODESEG32 ENDS